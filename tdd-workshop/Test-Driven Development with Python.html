<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>Test-Driven Development with Python</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Test-Driven Development with Python</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
<div class="toclevel1"><a href="#_tutorial_handout">Tutorial Handout</a></div><div class="toclevel1"><a href="#pre-requisites">Prerequisites and Assumptions</a></div><div class="toclevel2"><a href="#_required_software_installations">Required Software Installations</a></div><div class="toclevel1"><a href="#chapter-1">Getting Django Set Up Using a Functional Test</a></div><div class="toclevel2"><a href="#_obey_the_testing_goat_do_nothing_until_you_have_a_test">Obey the Testing Goat! Do Nothing Until You Have a Test</a></div><div class="toclevel2"><a href="#_getting_django_up_and_running">Getting Django Up and Running</a></div><div class="toclevel2"><a href="#_optional_starting_a_git_repository">Optional: Starting a Git repository</a></div><div class="toclevel1"><a href="#chapter-2">Extending Our Functional Test Using the unittest Module</a></div><div class="toclevel2"><a href="#_using_a_functional_test_to_scope_out_a_minimum_viable_app">Using a Functional Test to Scope Out a Minimum Viable App</a></div><div class="toclevel2"><a href="#_the_python_standard_library_8217_s_unittest_module">The Python Standard Library’s unittest Module</a></div><div class="toclevel2"><a href="#_implicit_waits">Implicit waits</a></div><div class="toclevel2"><a href="#_optional_commit">Optional: Commit</a></div><div class="toclevel1"><a href="#chapter-3">Testing a Simple Home Page with Unit Tests</a></div><div class="toclevel2"><a href="#_our_first_django_app_and_our_first_unit_test">Our First Django App, and Our First Unit Test</a></div><div class="toclevel2"><a href="#_unit_tests_and_how_they_differ_from_functional_tests">Unit Tests, and How They Differ from Functional Tests</a></div><div class="toclevel2"><a href="#_unit_testing_in_django">Unit Testing in Django</a></div><div class="toclevel2"><a href="#_django_8217_s_mvc_urls_and_view_functions">Django’s MVC, URLs, and View Functions</a></div><div class="toclevel2"><a href="#_unit_testing_a_view">Unit testing a view</a></div><div class="toclevel2"><a href="#_at_last_we_actually_write_some_application_code">At Last! We Actually Write Some Application Code!</a></div><div class="toclevel2"><a href="#_urls_py">Urls.py</a></div><div class="toclevel1"><a href="#chapter-4">What Are We Doing with All These Tests?</a></div><div class="toclevel2"><a href="#_using_selenium_to_test_user_interactions">Using Selenium to Test User Interactions</a></div><div class="toclevel2"><a href="#_the_8220_don_8217_t_test_constants_8221_rule_and_templates_to_the_rescue">The “Don’t Test Constants” Rule, and Templates to the Rescue</a></div><div class="toclevel2"><a href="#_on_refactoring">On refactoring</a></div><div class="toclevel2"><a href="#_a_little_more_of_our_front_page">A Little More of Our Front Page</a></div><div class="toclevel2"><a href="#_recap_the_tdd_process">Recap: The TDD Process</a></div><div class="toclevel1"><a href="#chapter-5">Saving User Input</a></div><div class="toclevel2"><a href="#_wiring_up_our_form_to_send_a_post_request">Wiring Up Our Form to Send a POST Request</a></div><div class="toclevel2"><a href="#_processing_a_post_request_on_the_server">Processing a POST Request on the Server</a></div><div class="toclevel2"><a href="#_passing_python_variables_to_be_rendered_in_the_template">Passing Python Variables to Be Rendered in the Template</a></div><div class="toclevel2"><a href="#_three_strikes_and_refactor">Three Strikes and Refactor</a></div><div class="toclevel2"><a href="#_the_django_orm_and_our_first_model">The Django ORM and Our First Model</a></div><div class="toclevel2"><a href="#_saving_the_post_to_the_database">Saving the POST to the Database</a></div><div class="toclevel2"><a href="#_redirect_after_a_post">Redirect After a POST</a></div><div class="toclevel2"><a href="#_rendering_items_in_the_template">Rendering Items in the Template</a></div><div class="toclevel2"><a href="#_creating_our_production_database_with_migrate">Creating Our Production Database with migrate</a></div><div class="toclevel1"><a href="#chapter-6">Getting to the Minimum Viable Site</a></div><div class="toclevel2"><a href="#_ensuring_test_isolation_in_functional_tests">Ensuring Test Isolation in Functional Tests</a></div><div class="toclevel2"><a href="#_small_design_when_necessary">Small Design When Necessary</a></div><div class="toclevel2"><a href="#_implementing_the_new_design_using_tdd">Implementing the New Design Using TDD</a></div><div class="toclevel2"><a href="#_iterating_towards_the_new_design">Iterating Towards the New Design</a></div><div class="toclevel2"><a href="#_testing_views_templates_and_urls_together_with_the_django_test_client">Testing Views, Templates, and URLs Together with the Django Test Client</a></div><div class="toclevel2"><a href="#_another_url_and_view_for_adding_list_items">Another URL and View for Adding List Items</a></div><div class="toclevel2"><a href="#_adjusting_our_models">Adjusting Our Models</a></div><div class="toclevel2"><a href="#_each_list_should_have_its_own_url">Each List Should Have Its Own URL</a></div><div class="toclevel2"><a href="#_one_more_view_to_handle_adding_items_to_an_existing_list">One More View to Handle Adding Items to an Existing List</a></div><div class="toclevel2"><a href="#_a_final_refactor_using_url_includes">A Final Refactor Using URL includes</a></div><div class="toclevel1"><a href="#_follow_up">Follow up!</a></div></div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_tutorial_handout">Tutorial Handout</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/cover-smaller.png" alt="images/cover-smaller.png">
</div>
</div>
<div class="paragraph"><p><a href="http://www.obeythetestinggoat.com/">www.obeythetestinggoat.com</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="pre-requisites">Prerequisites and Assumptions</h2>
<div class="sectionbody">
<div class="paragraph"><p>The tutorial uses Python 3.</p></div>
<div class="sect2">
<h3 id="_required_software_installations">Required Software Installations</h3>
<div class="paragraph"><p>Aside from Python, you’ll need:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Firefox</strong>
</p>
</li>
<li>
<p>
<strong>Git</strong>
</p>
</li>
<li>
<p>
<strong>Pip</strong>
</p>
</li>
<li>
<p>
<strong>Selenium</strong>
</p>
</li>
<li>
<p>
<strong>Django 1.8</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p>To make sure we’re using the Python3 version of pip, I’ll always use <code>pip3</code>
as the executable in my command-line examples.  Depending on your platform, it
may be <code>pip-3.3</code> or <code>pip-3.4</code>.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">If you’re stuck on Django 1.7 for whatever reason, you’ll be able to
    follow along just fine — the differences as pertains to this tutorial
    are negligible.</td>
</tr></tbody></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Windows Notes</div>
<div class="paragraph"><p>Windows users can sometimes feel a little neglected, since OS X and Linux make
it easy to forget there’s a world outside the Unix paradigm.  Backslashes
as directory separators?  Drive letters?  What?   Still, it is absolutely
possible to follow along with this book on Windows.  Here are a few tips:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
When you install Git for Windows, make sure you choose <em>"Run Git and included
Unix tools from the Windows command prompt"</em>. You’ll then get access to
a program called "Git Bash". Use this as your main command prompt and you’ll
get all the useful GNU command-line tools like <code>ls</code>, <code>touch</code>, and <code>grep</code>, plus
forward-slash directory separators.
</p>
</li>
<li>
<p>
When you install Python 3, make sure you tick the option that says
"add python.exe to Path" as in <a href="#add-python-to-path">[add-python-to-path]</a>, to make sure you can
run Python from the command line.
</p>
<div class="imageblock" id="add-python-to-path">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0001.png" alt="Screenshot of python installer">
</div>
<div class="title">Figure 1. Add python to the system path from the installer</div>
</div>
</li>
<li>
<p>
On Windows, Python 3’s executable is called <code>python.exe</code>, which is exactly
the same as Python 2.  To avoid any confusion, create a symlink in the Git Bash
binaries folder, like this:
</p>
<div class="listingblock">
<div class="content">
<pre><code><strong>ln -s /c/Python34/python.exe /bin/python3.exe</strong></code></pre>
</div></div>
<div class="paragraph"><p>You may need to right-click Git-Bash and choose "Run as an administrator" for
that command to work.  Note also that the symlink will only work in Git Bash,
not in the regular DOS command prompt.</p></div>
</li>
<li>
<p>
Python 3.4 comes with pip, the package management tool.  You can check
it’s installed by doing a <code>which pip3</code> from a command line, and it should
show you <code>/c/Python34/Scripts/pip3</code>.
</p>
<div class="paragraph"><p>If, for whatever reason, you’re stuck with Python 3.3 and you don’t have
<code>pip3</code>, check <a href="http://www.pip-installer.org/">http://www.pip-installer.org/</a>
for installation instructions. At the time of writing, this involved
downloading a file and then executing it with <code>python3 get-pip.py</code>.
<em>Make sure you use <code>python3</code> when you run the setup script</em>.</p></div>
</li>
</ol></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">The test for all this is that you should be able to go to a Git-Bash
command prompt and just run <code>python3</code> or <code>pip3</code> from any folder.</td>
</tr></tbody></table>
</div>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">MacOS Notes</div>
<div class="paragraph"><p>MacOS is a bit more sane than Windows, although getting <code>pip3</code> installed was
still fairly challenging up until recently. With the arrival of 3.4, things are
now quite straightforward:</p></div>
<div class="ulist"><ul>
<li>
<p>
Python 3.4 should install without a fuss from its
  <a href="http://www.python.org/">downloadable installer</a>.  It will automatically install
  pip, too.
</p>
</li>
<li>
<p>
Git’s installer should also "just work".
</p>
</li>
</ul></div>
<div class="paragraph"><p>Similarly to Windows, the test for all this is that you should be able to open
a terminal and just run <code>git</code>, <code>python3</code>, or <code>pip3</code> from anywhere.  If you run
into any trouble, the search terms "system path" and "command not found" should
provide good troubleshooting resources.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">You might also want to check out <a href="http://brew.sh//">Homebrew</a>.
It used to be the only reliable way of installing lots of Unixy tools
(including Python 3) on a Mac. Although the Python installer is now fine, you
may find it useful in future. It does require you to download all 1.1 GB of
Xcode, but that also gives you a C compiler, which is a useful side effect.</td>
</tr></tbody></table>
</div>
</div></div>
<div class="sect3">
<h4 id="_required_python_packages">Required Python Packages</h4>
<div class="paragraph"><p>Once you have <em>pip</em> installed, it’s trivial to install new Python packages.
We’ll install some as we go, but there are a couple we’ll need right from
the beginning, so you should install them right away:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Django</em>, <strong><code>sudo pip3 install django==1.8</code></strong> (omit the <code>sudo</code> on
Windows). This is our web framework. You should make sure you have version
1.8<span data-note="I updated the book to Django 1.8 in Spring 2015, and as it’s an
LTS, this will probably be the last upgrade for a while.  Make sure you install
this version, even if the Django project have released a newer one since.  You
can always jump to the bleeding edge when you go back to your own projects!" class="footnote">[<a id="_footnoteref_1" href="#_footnote_1" title="View footnote" class="footnote">1</a>]</span>
installed and that you can access the <code>django-admin.py</code> executable from a
command line.  The <a href="https://docs.djangoproject.com/en/1.8/intro/install/">Django
documentation</a> has some installation instructions if you need help.
</p>
</li>
<li>
<p>
<em>Selenium</em>, <strong><code>sudo pip3 install --upgrade selenium</code></strong> (omit the <code>sudo</code> on
Windows),
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Unless you’re absolutely sure you know what you’re doing, <em>don’t</em>
use a <code>virtualenv</code>.</td>
</tr></tbody></table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-1">Getting Django Set Up Using a <phrase role="keep-together">Functional Test</phrase></h2>
<div class="sectionbody">
<div class="imageblock" id="tree_goat">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0101.png" alt="A picture of a goat up a tree">
</div>
<div class="title">Figure 2. Goats are more agile than you think (source: <a href="http://www.flickr.com/photos/caitlinstewart/2846642630/">Caitlin Stewart, on Flickr</a>)</div>
</div>
<div class="sect2">
<h3 id="_obey_the_testing_goat_do_nothing_until_you_have_a_test">Obey the Testing Goat! Do Nothing Until You Have a Test</h3>
<div class="paragraph"><p>Here’s about the simplest imaginable test:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
<span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:8000'</span><span class="p">)</span>

<span class="k">assert</span> <span class="s">'Django'</span> <span class="ow">in</span> <span class="n">browser</span><span class="o">.</span><span class="n">title</span>
</pre></div></div></div>
<div class="paragraph"><p>Expected output:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
Traceback (most recent call last):
  File "functional_tests.py", line 6, in &lt;module&gt;
    assert 'Django' in browser.title
AssertionError</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_getting_django_up_and_running">Getting Django Up and Running</h3>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>django-admin.py startproject superlists</strong></code></pre>
</div></div>
<div class="paragraph"><p>That will create a folder called <em>superlists</em>, and a set of files and
subfolders inside it:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>.
├── functional_tests.py
└── superlists
    ├── manage.py
    └── superlists
        ├── __init__.py
        ├── settings.py
        ├── urls.py
        └── wsgi.py</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
ask about: why are there two folders called superlists?
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py runserver</strong>
Performing system checks...

System check identified no issues (0 silenced).

You have unapplied migrations; your app may not work properly until they are
applied.
Run 'python manage.py migrate' to apply them.

Django version 1.8, using settings 'superlists.settings'
Development server is running at <a href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>
Quit the server with CONTROL-C.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">It’s safe to ignore that message about "unapplied migrations" for now.
    We’ll look at migrations in <a href="#chapter-5">[chapter-5]</a>.</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Leave that running, and open another command shell.  In that, we can try
running our test again (from the folder we started in):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
$</code></pre>
</div></div>
<div class="paragraph"><p>Not much action on the command line, but you should notice two things: firstly,
there was no ugly <code>AssertionError</code> and secondly, the Firefox window that
Selenium popped up had a different-looking page on it.</p></div>
<div class="paragraph"><p>Well, it may not look like much, but that was our first ever passing test!
Hooray!</p></div>
<div class="paragraph"><p>If it all feels a bit too much like magic, like it wasn’t quite real, why not
go and take a look at the dev server manually, by opening a web browser
yourself and visiting <a href="http://localhost:8000/">http://localhost:8000</a>?  You should see something like
<a href="#it_worked_screenshot">[it_worked_screenshot]</a>.</p></div>
<div class="imageblock" id="it_worked_screenshot">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0102.png" alt="Screenshot of Django " it="" worked"="" screen"="">
</div>
<div class="title">Figure 3. It worked!</div>
</div>
<div class="paragraph"><p>You can quit the development server now if you like, back in the original
shell, using Ctrl-C.</p></div>
</div>
<div class="sect2">
<h3 id="_optional_starting_a_git_repository">Optional: Starting a Git repository</h3>
<div class="paragraph"><p>Let’s start by moving <em>functional_tests.py</em> into the <em>superlists</em> folder, and
doing the <code>git init</code> to start the repository:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>ls</strong>
superlists          functional_tests.py
$ <strong>mv functional_tests.py superlists/</strong>
$ <strong>cd superlists</strong>
$ <strong>git init .</strong>
Initialised empty Git repository in /workspace/superlists/.git/</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">From this point onwards, the top-level <em>superlists</em> folder will be our
working directory.  Whenever I show a command to type in, it will assume we’re
in this directory.  Similarly, if I mention a path to a file, it will be
relative to this top-level directory.  So <em>superlists/settings.py</em> means
the <em>settings.py</em> inside the second-level <em>superlists</em>. Clear as mud? If in
doubt, look for <em>manage.py</em>; you want to be in the same directory as
<em>manage.py</em>.</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Now let’s take a look and see what files we want to commit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>ls</strong>
db.sqlite3  manage.py   superlists  functional_tests.py</code></pre>
</div></div>
<div class="paragraph"><p><code>db.sqlite3</code> is a database file.  We don’t want to have that in
version control, so we add it to a special file called <em>.gitignore</em>
which, um, tells Git what to ignore:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>echo "db.sqlite3" &gt;&gt; .gitignore</strong></code></pre>
</div></div>
<div class="paragraph"><p>Next we can add the rest of the contents of the current folder, ".":</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git add .</strong>
$ <strong>git status</strong>
On branch master

Initial commit

Changes to be committed:
  (use "git rm --cached &lt;file&gt;..." to unstage)

        new file:   .gitignore
        new file:   functional_tests.py
        new file:   manage.py
        new file:   superlists/__init__.py
        new file:   superlists/__pycache__/__init__.cpython-34.pyc
        new file:   superlists/__pycache__/settings.cpython-34.pyc
        new file:   superlists/__pycache__/urls.cpython-34.pyc
        new file:   superlists/__pycache__/wsgi.cpython-34.pyc
        new file:   superlists/settings.py
        new file:   superlists/urls.py
        new file:   superlists/wsgi.py</code></pre>
</div></div>
<div class="paragraph"><p>Oops, remove <em>.pyc</em> files, and <em>.gitignore</em> them:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git rm -r --cached superlists/__pycache__</strong>
rm 'superlists/__pycache__/__init__.cpython-34.pyc'
rm 'superlists/__pycache__/settings.cpython-34.pyc'
rm 'superlists/__pycache__/urls.cpython-34.pyc'
rm 'superlists/__pycache__/wsgi.cpython-34.pyc'
$ <strong>echo "__pycache__" &gt;&gt; .gitignore</strong>
$ <strong>echo "*.pyc" &gt;&gt; .gitignore</strong></code></pre>
</div></div>
<div class="paragraph"><p>Now let’s see where we are…</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong>
On branch master

Initial commit

Changes to be committed:
  (use "git rm --cached &lt;file&gt;..." to unstage)

        new file:   .gitignore
        new file:   functional_tests.py
        new file:   manage.py
        new file:   superlists/__init__.py
        new file:   superlists/settings.py
        new file:   superlists/urls.py
        new file:   superlists/wsgi.py

Changes not staged for commit:
  (use "git add &lt;file&gt;..." to update what will be committed)
  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)

        modified:   .gitignore</code></pre>
</div></div>
<div class="paragraph"><p>Looking good, we’re ready to do our first commit!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git add .gitignore</strong>
$ <strong>git commit</strong></code></pre>
</div></div>
<div class="paragraph"><p>If vi pops up and you have no idea what to do, ask!</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>Can you swap out Firefox for another browser?  Chrome?  You’ll need something
called ChromeDriver.  Also, check out <code>PhantomJS</code></p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-2">Extending Our Functional Test Using the unittest Module</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_a_functional_test_to_scope_out_a_minimum_viable_app">Using a Functional Test to Scope Out a Minimum Viable App</h3>
<div class="paragraph"><p>FT = user story, written as comments:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

<span class="c"># Edith has heard about a cool new online to-do app. She goes</span>
<span class="c"># to check out its homepage</span>
<span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:8000'</span><span class="p">)</span>

<span class="c"># She notices the page title and header mention to-do lists</span>
<span class="k">assert</span> <span class="s">'To-Do'</span> <span class="ow">in</span> <span class="n">browser</span><span class="o">.</span><span class="n">title</span>

<span class="c"># She is invited to enter a to-do item straight away</span>

<span class="c"># She types "Buy peacock feathers" into a text box (Edith's hobby</span>
<span class="c"># is tying fly-fishing lures)</span>

<span class="c"># When she hits enter, the page updates, and now the page lists</span>
<span class="c"># "1: Buy peacock feathers" as an item in a to-do list</span>

<span class="c"># There is still a text box inviting her to add another item. She</span>
<span class="c"># enters "Use peacock feathers to make a fly" (Edith is very methodical)</span>

<span class="c"># The page updates again, and now shows both items on her list</span>

<span class="c"># Edith wonders whether the site will remember her list. Then she sees</span>
<span class="c"># that the site has generated a unique URL for her -- there is some</span>
<span class="c"># explanatory text to that effect.</span>

<span class="c"># She visits that URL - her to-do list is still there.</span>

<span class="c"># Satisfied, she goes back to sleep</span>

<span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div></div></div>
<div class="paragraph"><p>First, start up the server:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py runserver</strong></code></pre>
</div></div>
<div class="paragraph"><p>And then, in another shell, run the tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
Traceback (most recent call last):
  File "functional_tests.py", line 10, in &lt;module&gt;
    assert 'To-Do' in browser.title
AssertionError</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
"expected fail"
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_the_python_standard_library_8217_s_unittest_module">The Python Standard Library’s unittest Module</h3>
<div class="paragraph"><p>Fixing the unhelpful error message — option 1:</p></div>
<div class="listingblock skipme">
<div class="content"><div class="highlight"><pre><span class="k">assert</span> <span class="s">'To-Do'</span> <span class="ow">in</span> <span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"Browser title was "</span> <span class="o">+</span> <span class="n">browser</span><span class="o">.</span><span class="n">title</span>
</pre></div></div></div>
<div class="paragraph"><p>And we could also use a <code>try/finally</code> to clean up the old Firefox window.</p></div>
<div class="paragraph"><p>Better: use <code>unittest</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
        <span class="c"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:8000'</span><span class="p">)</span>

        <span class="c"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'To-Do'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/4.png" alt="4"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">'Finish the test!'</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/5.png" alt="5"></span>

        <span class="c"># She is invited to enter a to-do item straight away</span>
        <span class="p">[</span><span class="o">...</span><span class="n">rest</span> <span class="n">of</span> <span class="n">comments</span> <span class="k">as</span> <span class="n">before</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/6.png" alt="6"></span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="s">'ignore'</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/7.png" alt="7"></span>
</pre></div></div></div>
<div class="paragraph"><p>Make sure I explain all of the little numbers!</p></div>
<div class="paragraph"><p>Let’s try it!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 18, in
test_can_start_a_list_and_retrieve_it_later
    self.assertIn('To-Do', self.browser.title)
AssertionError: 'To-Do' not found in 'Welcome to Django'

 ---------------------------------------------------------------------
Ran 1 test in 1.747s

FAILED (failures=1)</code></pre>
</div></div>
<div class="paragraph"><p>Bonzer!</p></div>
</div>
<div class="sect2">
<h3 id="_implicit_waits">Implicit waits</h3>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>Find out about the <code>addCleanup</code> function.  How would you use it in this case?
What would it replace?  What do you think the advantages and disadvantages
might be?</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_optional_commit">Optional: Commit</h3>
<div class="paragraph"><p>Do a <strong><code>git status</code></strong>—that should assure you that the only file that has
changed is <em>functional_tests.py</em>.  Then do a <code>git diff</code>, which shows you the
difference between the last commit and what’s currently on disk. That should
tell you that <em>functional_tests.py</em> has changed quite substantially:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong>
diff --git a/functional_tests.py b/functional_tests.py
index d333591..b0f22dc 100644
--- a/functional_tests.py
+++ b/functional_tests.py
@@ -1,6 +1,45 @@
 from selenium import webdriver
+import unittest

-browser = webdriver.Firefox()
-browser.get('http://localhost:8000')
+class NewVisitorTest(unittest.TestCase):

-assert 'Django' in browser.title
+    def setUp(self):
+        self.browser = webdriver.Firefox()
+        self.browser.implicitly_wait(3)
+
+    def tearDown(self):
+        self.browser.quit()
[...]</code></pre>
</div></div>
<div class="paragraph"><p>Now let’s do a:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git commit -a</strong></code></pre>
</div></div>
<div class="paragraph"><p>The <strong><code>-a</code></strong> means “automatically add any changes to tracked files”</p></div>
<div class="paragraph"><p>When the editor pops up, add a descriptive commit message, like “First FT
specced out in comments, and now uses unittest”.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful TDD Concepts</div>
<div class="dlist"><dl>
<dt class="hdlist1">
User Story
</dt>
<dd>
<p>
    A description of how the application will work from the point of view
    of the user.  Used to structure a functional test.
</p>
</dd>
<dt class="hdlist1">
Expected failure
</dt>
<dd>
<p>
    When a test fails in the way that we expected it to.
</p>
</dd>
</dl></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-3">Testing a Simple Home Page with Unit Tests</h2>
<div class="sectionbody">
<div class="paragraph"><p>Let’s start an app for our to-do lists:</p></div>
<div class="sect2">
<h3 id="_our_first_django_app_and_our_first_unit_test">Our First Django App, and Our First Unit Test</h3>
<div class="paragraph"><p><em>Projects</em> are made up of <em>apps</em>…</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py startapp lists</strong></code></pre>
</div></div>
<div class="paragraph"><p>That will create a folder at <em>superlists/lists</em>, next to
<em>superlists/superlists</em>, and within it a number of placeholder files for
things like models, views, and, of immediate interest to us, tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>superlists/
├── db.sqlite3
├── functional_tests.py
├── lists
│&nbsp;&nbsp; ├── admin.py
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; ├── migrations
│&nbsp;&nbsp; │&nbsp;&nbsp; └── __init__.py
│&nbsp;&nbsp; ├── models.py
│&nbsp;&nbsp; ├── tests.py
│&nbsp;&nbsp; └── views.py
├── manage.py
└── superlists
    ├── __init__.py
    ├── __pycache__
    ├── settings.py
    ├── urls.py
    └── wsgi.py</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_unit_tests_and_how_they_differ_from_functional_tests">Unit Tests, and How They Differ from Functional Tests</h3>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">a good place to ask questions, if I don’t explain myself well here!</td>
</tr></tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_in_django">Unit Testing in Django</h3>
<div class="paragraph"><p>Let’s see how to write a unit test for our home page view. Open up the new
file at <em>lists/tests.py</em>, and you’ll see something like this:</p></div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="c"># Create your tests here.</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s deliberately create a breaking test and see if we can see it fail.</p></div>
<!--?hard-pagebreak?-->
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">SmokeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_bad_maths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Now let’s invoke this mysterious Django test runner. As usual, it’s a
<em>manage.py</em> <phrase role="keep-together">command:</phrase></p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
Creating test database for alias 'default'...
F
======================================================================
FAIL: test_bad_maths (lists.tests.SmokeTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/lists/tests.py", line 6, in test_bad_maths
    self.assertEqual(1 + 1, 3)
AssertionError: 2 != 3

 ---------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (failures=1)
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="paragraph"><p>Excellent.  The machinery seems to be working. This is a good point for a
commit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong>  # should show you lists/ is untracked
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>  # will show you the diff that you're about to commit
$ <strong>git commit -m "Add app for lists, with deliberately failing unit test"</strong></code></pre>
</div></div>
<div class="paragraph"><p>As no doubt you’ve guessed, the <code>-m</code> flag lets you pass in a commit message
at the command-line.</p></div>
</div>
<div class="sect2">
<h3 id="_django_8217_s_mvc_urls_and_view_functions">Django’s MVC, URLs, and View Functions</h3>
<div class="ulist"><ul>
<li>
<p>
MVC
</p>
</li>
<li>
<p>
resolving URLs
</p>
</li>
<li>
<p>
view functions
</p>
</li>
</ul></div>
<div class="paragraph"><p>Open up <em>lists/tests.py</em>, and change our silly test to something like this:</p></div>
</div>
<div class="sect2">
<h3 id="_unit_testing_a_view">Unit testing a view</h3>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpRequest</span>

<span class="kn">from</span> <span class="nn">lists.views</span> <span class="kn">import</span> <span class="n">home_page</span>


<span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_home_page_returns_correct_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">'&lt;html&gt;'</span><span class="p">))</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">b</span><span class="s">'&lt;title&gt;To-Do lists&lt;/title&gt;'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/4.png" alt="4"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">'&lt;/html&gt;'</span><span class="p">))</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></span>
</pre></div></div></div>
<div class="paragraph"><p>So, what do you think will happen when we run the tests?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
ImportError: cannot import name 'home_page'</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_at_last_we_actually_write_some_application_code">At Last! We Actually Write Some Application Code!</h3>
<div class="paragraph"><p>What next?</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="c"># Create your views here.</span>
<span class="n">home_page</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div></div></div>
<div class="paragraph"><p>Yeah. Srsly</p></div>
<div class="sect3">
<h4 id="_unit_test_code_cycle">Unit test / code cycle</h4>
<div class="listingblock">
<div class="content">
<pre><code>    response = home_page(request)
TypeError: 'NoneType' object is not callable</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
minimal code:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="c"># Create your views here.</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
tests:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>TypeError: home_page() takes 0 positional arguments but 1 was given</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
code:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.startswith(b'&lt;html&gt;'))
AttributeError: 'NoneType' object has no attribute 'content'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code—we use <code>django.http.HttpResponse</code>, as predicted:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="c"># Create your views here.</span>
<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests again:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.startswith(b'&lt;html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code again:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'&lt;html&gt;'</span><span class="p">)</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: b'&lt;title&gt;To-Do lists&lt;/title&gt;' not found in b'&lt;html&gt;'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;'</span><span class="p">)</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests—almost there?
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.endswith(b'&lt;/html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Come on, one last effort:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">'&lt;html&gt;&lt;title&gt;To-Do lists&lt;/title&gt;&lt;/html&gt;'</span><span class="p">)</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Surely?
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
Creating test database for alias 'default'...
.
 ---------------------------------------------------------------------
Ran 1 test in 0.003s

OK
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="paragraph"><p>Yes!  Now, let’s run our functional tests.  Don’t forget to spin up the dev
server again, if it’s not still running. It feels like the final heat
of the race here, surely this is it … could it be?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 19, in
test_can_start_a_list_and_retrieve_it_later
    self.assertIn('To-Do', self.browser.title)
AssertionError: 'To-Do' not found in 'Welcome to Django'

 ---------------------------------------------------------------------
Ran 1 test in 1.747s

FAILED (failures=1)</code></pre>
</div></div>
<div class="paragraph"><p>Nope!</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_urls_py">Urls.py</h3>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>How would you write a unit test for urls.py?  Hint: look into the Django
<em>reverse</em> and <em>resolve</em> functions.</p></div>
</div></div>
<div class="paragraph"><p>Back to FTS:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 20, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</code></pre>
</div></div>
<div class="paragraph"><p>Yay!  expected failure.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong> # should show urls.py, tests.py, views.py
$ <strong>git commit -am"Basic view now returns minimal HTML"</strong></code></pre>
</div></div>
<div class="paragraph"><p>Not bad—we covered:</p></div>
<div class="ulist"><ul>
<li>
<p>
Starting a Django app
</p>
</li>
<li>
<p>
The Django unit test runner
</p>
</li>
<li>
<p>
The difference between FTs and unit tests
</p>
</li>
<li>
<p>
Django URL resolving and <em>urls.py</em>
</p>
</li>
<li>
<p>
Django view functions, request and response objects
</p>
</li>
<li>
<p>
And returning basic HTML
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful Commands and Concepts</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Running the Django dev server
</dt>
<dd>
<p>
    <strong><code>python3 manage.py runserver</code></strong>
</p>
</dd>
<dt class="hdlist1">
Running the functional tests
</dt>
<dd>
<p>
    <strong><code>python3 functional_tests.py</code></strong>
</p>
</dd>
<dt class="hdlist1">
Running the unit tests
</dt>
<dd>
<p>
    <strong><code>python3 manage.py test</code></strong>
</p>
</dd>
<dt class="hdlist1">
The unit-test/code cycle
</dt>
<dd>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Run the unit tests in the terminal.
</p>
</li>
<li>
<p>
Make a minimal code change in the editor.
</p>
</li>
<li>
<p>
Repeat!
</p>
</li>
</ol></div>
</dd>
</dl></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-4">What Are We Doing with All These Tests?</h2>
<div class="sectionbody">
<div class="imageblock" id="figure4-1">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0401.png" alt="Test ALL the things">
</div>
<div class="title">Figure 4. Test ALL the things (original illustration source: <a href="http://bit.ly/1iXxdYp">Allie Brosh, Hyperbole and a Half</a>)</div>
</div>
<div class="paragraph"><p>Topics to discuss:</p></div>
<div class="ulist"><ul>
<li>
<p>
"Bucket from a well" metaphor
</p>
</li>
<li>
<p>
TDD as a discipline — kata
</p>
</li>
<li>
<p>
the value of ridiculously small/simple tests?
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now, back to our onions.</p></div>
<div class="sect2">
<h3 id="_using_selenium_to_test_user_interactions">Using Selenium to Test User Interactions</h3>
<div class="paragraph"><p>Where were we at the end of the last chapter? Let’s rerun the test and find
out:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later (__main__.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "functional_tests.py", line 20, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 1.609s

FAILED (failures=1)</code></pre>
</div></div>
<div class="paragraph"><p>Did you try it, and get an error saying <em>Problem loading page</em> or
<em>Unable to connect</em>?  So did I. It’s because we forgot to spin up the dev
server first using <code>manage.py runserver</code>.  Do that, and you’ll get the failure
message we’re after.</p></div>
<div class="paragraph"><p>“Finish the test”, it says, so let’s do just that!  Open up
<em>functional_tests.py</em> and we’ll extend our FT:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:8000'</span><span class="p">)</span>

        <span class="c"># She notices the page title and header mention to-do lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'To-Do'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="n">header_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s">'h1'</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'To-Do'</span><span class="p">,</span> <span class="n">header_text</span><span class="p">)</span>

        <span class="c"># She is invited to enter a to-do item straight away</span>
        <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_new_item'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">inputbox</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">'placeholder'</span><span class="p">),</span>
                <span class="s">'Enter a to-do item'</span>
        <span class="p">)</span>

        <span class="c"># She types "Buy peacock feathers" into a text box (Edith's hobby</span>
        <span class="c"># is tying fly-fishing lures)</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Buy peacock feathers'</span><span class="p">)</span>

        <span class="c"># When she hits enter, the page updates, and now the page lists</span>
        <span class="c"># "1: Buy peacock feathers" as an item in a to-do list table</span>
        <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_list_table'</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s">'tr'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">'1: Buy peacock feathers'</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c"># There is still a text box inviting her to add another item. She</span>
        <span class="c"># enters "Use peacock feathers to make a fly" (Edith is very</span>
        <span class="c"># methodical)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">'Finish the test!'</span><span class="p">)</span>

        <span class="c"># The page updates again, and now shows both items on her list</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Ask about:
* <code>find_element_by_tag_name</code>, <code>find_element_by_id</code>,
* <code>find_element</code><strong><code>s</code></strong><code>_by_tag_name</code> (notice the extra <code>s</code>)
* <code>send_keys</code>,
* <code>Keys</code> class
* <code>any</code> function + generator expressions</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">Watch out for the difference between the Selenium <code>find_element_by...</code>
and <code>find_elements_by...</code> functions.  One returns an element, and raises
an exception if it can’t find it, whereas the other returns a list, which
may be empty.</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Let’s see how it gets on:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"tag name","selector":"h1"}
Stacktrace:
[...]</code></pre>
</div></div>
<div class="paragraph"><p>Big changes to a functional test are usually a good thing to commit on their
own</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong>  # should show changes to functional_tests.py
$ <strong>git commit -am "Functional test now checks we can input a to-do item"</strong></code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_the_8220_don_8217_t_test_constants_8221_rule_and_templates_to_the_rescue">The “Don’t Test Constants” Rule, and Templates to the Rescue</h3>
<div class="paragraph"><p>In other words, if you have some code that says:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">wibble</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div></div></div>
<div class="paragraph"><p>There’s not much point in a test that says:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">myprogram</span> <span class="kn">import</span> <span class="n">wibble</span>
<span class="k">assert</span> <span class="n">wibble</span> <span class="o">==</span> <span class="mi">3</span>
</pre></div></div></div>
<div class="sect3">
<h4 id="_refactoring_to_use_a_template">Refactoring to Use a Template</h4>
<div class="paragraph"><p>Objective: <strong>refactor</strong> view to return same HTML</p></div>
<div class="paragraph"><p>Start with test run:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
[...]
OK</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;title&gt;</span>To-Do lists<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Mmmh, syntax-highlighted … much nicer! Now to change our view function:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s see if it works:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
[...]
======================================================================
ERROR: test_home_page_returns_correct_html (lists.tests.HomePageTest)<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2">
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/lists/tests.py", line 17, in
test_home_page_returns_correct_html
    response = home_page(request)<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3">
  File "/workspace/superlists/lists/views.py", line 5, in home_page
    return render(request, 'home.html')<img src="Test-Driven%20Development%20with%20Python_files/4.png" alt="4">
  File "/usr/local/lib/python3.3/dist-packages/django/shortcuts.py", line 48,
in render
    return HttpResponse(loader.render_to_string(*args, **kwargs),
  File "/usr/local/lib/python3.3/dist-packages/django/template/loader.py", line
170, in render_to_string
    t = get_template(template_name, dirs)
  File "/usr/local/lib/python3.3/dist-packages/django/template/loader.py", line
144, in get_template
    template, origin = find_template(template_name, dirs)
  File "/usr/local/lib/python3.3/dist-packages/django/template/loader.py", line
136, in find_template
    raise TemplateDoesNotExist(name)
django.template.base.TemplateDoesNotExist: home.html<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1">

 ---------------------------------------------------------------------
Ran 2 tests in 0.004s</code></pre>
</div></div>
<div class="paragraph"><p>Another chance to analyse a traceback:</p></div>
<div class="colist arabic"><table>
<tbody><tr><td><img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></td><td>
We start with the error: it can’t find the template.
</td></tr>
<tr><td><img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></td><td>
Then we double-check what test is failing: sure enough, it’s our test
    of the view HTML.
</td></tr>
<tr><td><img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></td><td>
Then we find the line in our tests that caused the failure: it’s when
    we call the <code>home_page</code> function.
</td></tr>
<tr><td><img src="Test-Driven%20Development%20with%20Python_files/4.png" alt="4"></td><td>
Finally, we look for the part of our own application code that caused the
    failure: it’s when we try and call <code>render</code>.
</td></tr>
</tbody></table></div>
<div class="paragraph"><p>So why can’t Django find the template?  It’s right where it’s supposed to be,
in the <em>lists/templates</em> folder.</p></div>
<div class="ulist"><ul>
<li>
<p>
Need to add lists app to <em>settings.py</em>:
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">superlists/settings.py</div>
<div class="content"><div class="highlight"><pre><span class="c"># Application definition</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'lists'</span><span class="p">,</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Does that do the trick?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
    [...]
    self.assertTrue(response.content.endswith(b'&lt;/html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="paragraph"><p>Darn, not quite.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Depending on whether your text editor insists on adding newlines to the
      end of files, you may not even see this error.  If so, you can safely
      ignore the next bit, and skip straight to where you can see the listing
      says OK.</td>
</tr></tbody></table>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">b</span><span class="s">'&lt;/html&gt;'</span><span class="p">))</span>
</pre></div></div></div>
<div class="paragraph"><p>hooray!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
[...]
OK</code></pre>
</div></div>
<div class="paragraph"><p>Now we can change the tests so that they’re no longer testing constants</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_home_page_returns_correct_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">expected_html</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s">'home.html'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">expected_html</span><span class="p">)</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
ask about .decode() if we haven’t spoken about Python 3 and strings vs bytes
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>Look up the Django Test Client.  How would you use it to check that our view
is using the correct template?</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_on_refactoring">On refactoring</h3>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Am I recommending that you actually work this way? No. I’m recommending that
you be <em>able</em> to work this way.</p></div>
</div>
<div class="attribution">
<em>TDD by example</em><br>
— Kent Beck
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">When refactoring, work on either the code or the tests, but not both at
     once.</td>
</tr></tbody></table>
</div>
<div class="imageblock" id="RefactoringCat">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0402.png" alt="An adventurous cat">
</div>
<div class="title">Figure 5. Refactoring Cat—be sure to look up the full animated GIF (source: 4GIFs.com)</div>
</div>
<div class="paragraph"><p>It’s a good idea to do a commit after any refactoring:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # see tests.py, views.py, settings.py, + new templates folder
$ <strong>git add .</strong>  # will also add the untracked templates folder
$ <strong>git diff --staged</strong> # review the changes we're about to commit
$ <strong>git commit -m "Refactor home page view to use a template"</strong></code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_a_little_more_of_our_front_page">A Little More of Our Front Page</h3>
<div class="paragraph"><p>In the meantime, our functional test is still failing.  Let’s now make an
actual code change to get it passing.</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>To-Do lists<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Your To-Do list<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s see if our functional test likes it a little better:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_new_item"}</code></pre>
</div></div>
<div class="paragraph"><p>OK…</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre>    [...]
        <span class="nt">&lt;h1&gt;</span>Your To-Do list<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
    [...]
</pre></div></div></div>
<div class="paragraph"><p>And now?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '' != 'Enter a to-do item'</code></pre>
</div></div>
<div class="paragraph"><p>We add our placeholder text…</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Which gives:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_list_table"}</code></pre>
</div></div>
<div class="paragraph"><p>So we can go ahead and put the table onto the page. At this stage it’ll just be
empty…</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"id_list_table"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now what does the FT say?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  File "functional_tests.py", line 42, in
test_can_start_a_list_and_retrieve_it_later
    any(row.text == '1: Buy peacock feathers' for row in rows)
AssertionError: False is not true</code></pre>
</div></div>
<div class="paragraph"><p>That <code>any</code> function!</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">'1: Buy peacock feathers'</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span>
        <span class="s">"New to-do item did not appear in table"</span>
    <span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>If you run the FT again, you should see our message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : New to-do item did not appear in table</code></pre>
</div></div>
<div class="paragraph"><p>But now, to get this to pass, we will need to actually process the user’s
form submission.  And that’s a topic for the next chapter.</p></div>
<div class="paragraph"><p>For now let’s do a commit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong>
$ <strong>git commit -am "Front page HTML now generated from a template"</strong></code></pre>
</div></div>
<div class="paragraph"><p>Thanks to a bit of refactoring, we’ve got our view set up to render a template,
we’ve stopped testing constants, and we’re now well placed to start processing
user input.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>How could we improve that check-that-the-new-item-has-appeared-in-the-table
assertion further?</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_recap_the_tdd_process">Recap: The TDD Process</h3>
<div class="paragraph"><p>We’ve now seen all the main aspects of the TDD process, in practice:</p></div>
<div class="ulist"><ul>
<li>
<p>
Functional tests
</p>
</li>
<li>
<p>
Unit tests
</p>
</li>
<li>
<p>
The unit-test/code cycle
</p>
</li>
<li>
<p>
Refactoring
</p>
</li>
</ul></div>
<div class="paragraph"><p>What is the overall TDD process? See <a href="#simple-TDD-diagram">[simple-TDD-diagram]</a>.</p></div>
<div class="imageblock" id="simple-TDD-diagram">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0403.png" alt="A flowchart showing tests">
</div>
<div class="title">Figure 6. Overall TDD process</div>
</div>
<div class="imageblock" id="Double-Loop-TDD-diagram">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0404.png" alt="A flowchart showing functional tests as the overall cycle">
</div>
<div class="title">Figure 7. The TDD process with functional and unit tests</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How to "Check" Your Code, or Skip Ahead (If You Must)</div>
<div class="paragraph"><p>All of the code examples I’ve used in the book are available in
<a href="https://github.com/hjwp/book-example/">my repo</a> on GitHub.  So, if you ever want
to compare your code against mine, you can take a look at it there.</p></div>
<div class="paragraph"><p>Each chapter has its own branch following the convention <code>chapter_XX</code>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Chapter 3: <a href="https://github.com/hjwp/book-example/tree/chapter_03">https://github.com/hjwp/book-example/tree/chapter_03</a>
</p>
</li>
<li>
<p>
Chapter 4: <a href="https://github.com/hjwp/book-example/tree/chapter_04">https://github.com/hjwp/book-example/tree/chapter_04</a>
</p>
</li>
<li>
<p>
Chapter 5: <a href="https://github.com/hjwp/book-example/tree/chapter_05">https://github.com/hjwp/book-example/tree/chapter_05</a>
</p>
</li>
<li>
<p>
Etc.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Be aware that each branch contains all of the commits for that chapter,
so its state represents the code at the <em>end</em> of the chapter.</p></div>
<div class="paragraph"><p><strong>Using Git to check your progress</strong></p></div>
<div class="paragraph"><p>If you feel like developing your Git-Fu a little further, you can add
my repo as a <em>remote</em>:</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>git remote add harry https://github.com/hjwp/book-example.git
git fetch harry</code></pre>
</div></div>
<div class="paragraph"><p>And then, to check your difference from the <em>end</em> of <a href="#chapter-4">[chapter-4]</a>:</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>git diff harry/chapter_04</code></pre>
</div></div>
<div class="paragraph"><p>Git can handle multiple remotes, so you can still do this even if you’re
already pushing your code up to GitHub or Bitbucket.</p></div>
<div class="paragraph"><p>Be aware that the precise order of, say, methods in a class may differ
between your version and mine.  It may make diffs hard to read.</p></div>
<div class="paragraph"><p><strong>Downloading a ZIP file for a chapter</strong></p></div>
<div class="paragraph"><p><a href="https://github.com/hjwp/book-example/archive/chapter_05.zip">https://github.com/hjwp/book-example/archive/chapter_05.zip</a></p></div>
<div class="paragraph"><p><a href="https://github.com/hjwp/book-example/archive/chapter_06.zip">https://github.com/hjwp/book-example/archive/chapter_06.zip</a></p></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-5">Saving User Input</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_wiring_up_our_form_to_send_a_post_request">Wiring Up Our Form to Send a POST Request</h3>
<div class="paragraph"><p>To get our browser to send a POST request, we need to do two things:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Give the <code>&lt;input&gt;</code> element a <code>name=</code> attribute
</p>
</li>
<li>
<p>
Wrap it in a <code>&lt;form&gt;</code> tag with <code>method="POST"</code>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Let’s adjust our template at <em>lists/templates/home.html</em>:</p></div>
<div class="listingblock sourcecode dofirst-ch05l000">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Your To-Do list<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"item_text"</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"id_list_table"</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, running our FTs gives us a slightly cryptic, unexpected error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
[...]
Traceback (most recent call last):
  File "functional_tests.py", line 39, in
test_can_start_a_list_and_retrieve_it_later
    table = self.browser.find_element_by_id('id_list_table')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_list_table"}</code></pre>
</div></div>
<div class="paragraph"><p>When a functional test fails with an unexpected failure, there are several
things we can do to debug them:</p></div>
<div class="ulist"><ul>
<li>
<p>
Add <code>print</code> statements, to show, eg, what the current page text is.
</p>
</li>
<li>
<p>
Improve the <em>error message</em> to show more info about the current state.
</p>
</li>
<li>
<p>
Manually visit the site yourself.
</p>
</li>
<li>
<p>
Use <code>time.sleep</code> to pause the test during execution.
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="c"># When she hits enter, the page updates, and now the page lists</span>
    <span class="c"># "1: Buy peacock feathers" as an item in a to-do list table</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_list_table'</span><span class="p">)</span>
</pre></div></div></div>
<div class="imageblock" id="csrf_error_screenshot">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0501.png" alt="Django DEBUG page showing CSRF error">
</div>
<div class="title">Figure 8. Django DEBUG page showing CSRF error</div>
</div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">check out Ross Anderson’s "Security Engineering"</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>csrf token magic:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"item_text"</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
    {% csrf_token %}
<span class="nt">&lt;/form&gt;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : New to-do item did not appear in table</code></pre>
</div></div>
<div class="paragraph"><p>We can remove the <code>time.sleep</code> now though:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="c"># "1: Buy peacock feathers" as an item in a to-do list table</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_list_table'</span><span class="p">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_processing_a_post_request_on_the_server">Processing a POST Request on the Server</h3>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch05l005)</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_home_page_returns_correct_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_home_page_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s">'POST'</span>
    <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'A new list item'</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'A new list item'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Ask about: line spacing in tests
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
[...]
AssertionError: 'A new list item' not found in '&lt;html&gt; [...]</code></pre>
</div></div>
<div class="paragraph"><p>In typical TDD style, we start with a deliberately silly return value:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gets our unit tests passing, but it’s not really what we want.  What we
really want to do is add the POST submission to the table in the home page
template.</p></div>
</div>
<div class="sect2">
<h3 id="_passing_python_variables_to_be_rendered_in_the_template">Passing Python Variables to Be Rendered in the Template</h3>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Your To-Do list<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"item_text"</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
        {% csrf_token %}
    <span class="nt">&lt;/form&gt;</span>

    <span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"id_list_table"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ new_item_text }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Use template variable in test:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'A new list item'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">expected_html</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span>
        <span class="s">'home.html'</span><span class="p">,</span>
        <span class="p">{</span><span class="s">'new_item_text'</span><span class="p">:</span>  <span class="s">'A new list item'</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">expected_html</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Next:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(response.content.decode(), expected_html)
AssertionError: 'A new list item' != '&lt;html&gt;\n    &lt;head&gt;\n [...]</code></pre>
</div></div>
<div class="paragraph"><p>use in view:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch05l009)</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'new_item_text'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">],</span>
    <span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>Running the unit tests again:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ERROR: test_home_page_returns_correct_html (lists.tests.HomePageTest)
[...]
    'new_item_text': request.POST['item_text'],
KeyError: 'item_text'</code></pre>
</div></div>
<div class="paragraph"><p>An "unexpected failure"…  in a different test!  <em>This is the whole point of
having tests</em>.</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'new_item_text'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'item_text'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">})</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
confused about request.POST.get?  ask!
</p>
</li>
</ul></div>
<div class="paragraph"><p>The unit tests should now pass.  Let’s see what the functional tests say:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : New to-do item did not appear in table</code></pre>
</div></div>
<div class="paragraph"><p>Hmm, not a wonderfully helpful error.  Let’s use another of our FT debugging
techniques: improving the error message.  This is probably the most
constructive technique, because those improved error messages stay around to
help debug any future errors:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
        <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">'1: Buy peacock feathers'</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span>
        <span class="s">"New to-do item did not appear in table -- its text was:</span><span class="se">\n</span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gives us a more helpful error message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : New to-do item did not appear in table --
its text was:
Buy peacock feathers</code></pre>
</div></div>
<div class="paragraph"><p>You know what could be even better than that?</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Discussion point: feeling clever about your code is a code smell!
</p>
</li>
</ul></div>
<div class="paragraph"><p>Much better.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertIn('1: Buy peacock feathers', [row.text for row in rows])
AssertionError: '1: Buy peacock feathers' not found in ['Buy peacock feathers']</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">If, instead, your FT seems to be saying the table is empty ("not found in
[]"), check your <code>&lt;input&gt;</code> tag — does it have the correct <code>name="item_text"</code>
attribute?  Without it, the user’s input won’t be associated with the right
key in <code>request.POST</code>.</td>
</tr></tbody></table>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;tr&gt;&lt;td&gt;</span>1: {{ new_item_text }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">ask about Red/Green/Refactor, and Triangulation</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Now we get to the <code>self.fail('Finish the test!')</code>.  If we extend our FT to
check for adding a second item to the table (copy and paste is our friend), we
begin to see that our first cut solution really isn’t going to, um, cut it:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="c"># There is still a text box inviting her to add another item. She</span>
    <span class="c"># enters "Use peacock feathers to make a fly" (Edith is very</span>
    <span class="c"># methodical)</span>
    <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_new_item'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Use peacock feathers to make a fly'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

    <span class="c"># The page updates again, and now shows both items on her list</span>
    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_list_table'</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s">'tr'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span>
        <span class="s">'2: Use peacock feathers to make a fly'</span> <span class="p">,</span>
         <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c"># Edith wonders whether the site will remember her list. Then she sees</span>
    <span class="c"># that the site has generated a unique URL for her -- there is some</span>
    <span class="c"># explanatory text to that effect.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">'Finish the test!'</span><span class="p">)</span>

    <span class="c"># She visits that URL - her to-do list is still there.</span>
</pre></div></div></div>
<div class="paragraph"><p>Sure enough, the functional tests return an error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_three_strikes_and_refactor">Three Strikes and Refactor</h3>
<div class="paragraph"><p>Before we go further—we’ve got a bad “code smell” in this FT.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong>
# should show changes to functional_tests.py, home.html,
# tests.py and views.py
$ <strong>git commit -a</strong></code></pre>
</div></div>
<div class="paragraph"><p>Helper:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">check_for_row_in_list_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_text</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_list_table'</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s">'tr'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">row_text</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s use it in the FT:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="c"># When she hits enter, the page updates, and now the page lists</span>
    <span class="c"># "1: Buy peacock feathers" as an item in a to-do list table</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">)</span>

    <span class="c"># There is still a text box inviting her to add another item. She</span>
    <span class="c"># enters "Use peacock feathers to make a fly" (Edith is very</span>
    <span class="c"># methodical)</span>
    <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_new_item'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Use peacock feathers to make a fly'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

    <span class="c"># The page updates again, and now shows both items on her list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'2: Use peacock feathers to make a fly'</span><span class="p">)</span>

    <span class="c"># Edith wonders whether the site will remember her list. Then she sees</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>We run the FT again to check that it still behaves in the same way…</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '1: Buy peacock feathers' not found in ['1: Use peacock
feathers to make a fly']</code></pre>
</div></div>
<div class="paragraph"><p>Good. Now we can commit the FT refactor as its own small, atomic change:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong> # check the changes to functional_tests.py
$ <strong>git commit -a</strong></code></pre>
</div></div>
<div class="paragraph"><p>And back to work.</p></div>
</div>
<div class="sect2">
<h3 id="_the_django_orm_and_our_first_model">The Django ORM and Our First Model</h3>
<div class="paragraph"><p>Let’s create a new class in <em>lists/tests.py</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">ItemModelTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_saving_and_retrieving_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'The first (ever) list item'</span>
        <span class="n">first_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">second_item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Item the second'</span>
        <span class="n">second_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">saved_items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">saved_items</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">first_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_saved_item</span> <span class="o">=</span> <span class="n">saved_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'The first (ever) list item'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second_saved_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'Item the second'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Django’s ORM has many other helpful and intuitive features; this might be a
good time to skim through the
<a href="https://docs.djangoproject.com/en/1.8/intro/tutorial01/">Django
tutorial</a>, which has an excellent intro to them.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">I’ve written this unit test in a very verbose style, as a way of
introducing the Django ORM.  You can actually write a much shorter test for a
model class, which we’ll see later on, in <a href="#simple-form-chapter">[simple-form-chapter]</a>.</td>
</tr></tbody></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>What’s the simplest version of this test that still thoroughly tests the
class?</p></div>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Ask about integrated vs pure unit tests, and "the database is Hot Lava!"</td>
</tr></tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre><code>ImportError: cannot import name 'Item'</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="paragraph"><p>That gets our test as far as:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    first_item.save()
AttributeError: 'Item' object has no attribute 'save'</code></pre>
</div></div>
<div class="paragraph"><p>To give our <code>Item</code> class a <code>save</code> method, and to make it into a real Django
model, we make it inherit from the <code>Model</code> class:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="sect3">
<h4 id="_our_first_database_migration">Our First Database Migration</h4>
<div class="paragraph"><p>The next thing that happens is a database error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>django.db.utils.OperationalError: no such table: lists_item</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Ask about "migrations are a VCS for your database"</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>For now all we need to know is how to build our first database migration,
which we do using the <code>makemigrations</code> command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0001_initial.py:
    - Create model Item
$ <strong>ls lists/migrations</strong>
0001_initial.py  __init__.py  __pycache__</code></pre>
</div></div>
<div class="paragraph"><p>If you’re curious, you can go and take a look in the migrations file,
and you’ll see it’s a representation of our additions to <em>models.py</em>.</p></div>
<div class="paragraph"><p>In the meantime, we should find our tests get a little further.</p></div>
</div>
<div class="sect3">
<h4 id="_the_test_gets_surprisingly_far">The Test Gets Surprisingly Far</h4>
<div class="paragraph"><p>The test actually gets surprisingly far:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
[...]
    self.assertEqual(first_saved_item.text, 'The first (ever) list item')
AttributeError: 'Item' object has no attribute 'text'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Discussion:  how did it get this far?
</p>
</li>
</ul></div>
<div class="paragraph"><p>Next:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
</pre></div></div></div>
<div class="paragraph"><p>You can read more on field types in the Django
<a href="http://bit.ly/1slDAGH">tutorial</a>
and in the
<a href="https://docs.djangoproject.com/en/1.8/ref/models/fields/">documentation</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_a_new_field_means_a_new_migration">A New Field Means a New Migration</h4>
<div class="paragraph"><p>Running the tests gives us another database error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>django.db.utils.OperationalError: no such column: lists_item.text</code></pre>
</div></div>
<div class="paragraph"><p>It’s because we’ve added another new field to our database, which means we need
to create another migration.  Nice of our tests to let us know!</p></div>
<div class="paragraph"><p>Let’s try it:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py makemigrations</strong>
You are trying to add a non-nullable field 'text' to item without a default; we
can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows)
 2) Quit, and let me add a default in models.py
Select an option:<strong>2</strong></code></pre>
</div></div>
<div class="paragraph"><p>Ah.  It won’t let us add the column without a default value.  Let’s pick option
2 and set a default in <em>models.py</em>.  I think you’ll find the syntax reasonably
self-explanatory:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And now the migration should complete:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0002_item_text.py:
    - Add field text to item</code></pre>
</div></div>
<div class="paragraph"><p>So, two new lines in <em>models.py</em>, two database migrations, and as a result,
the <code>.text</code> attribute on our model objects is now
recognised as a special attribute, so it does get saved to the database, and
the tests pass…</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
[...]

Ran 4 tests in 0.010s
OK</code></pre>
</div></div>
<div class="paragraph"><p>So let’s do a commit for our first ever model!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # see tests.py, models.py, and 2 untracked migrations
$ <strong>git diff</strong> # review changes to tests.py and models.py
$ <strong>git add lists</strong>
$ <strong>git commit -m "Model for list Items and associated migration"</strong></code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_saving_the_post_to_the_database">Saving the POST to the Database</h3>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_home_page_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s">'POST'</span>
    <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'A new list item'</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
    <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'A new list item'</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/3.png" alt="3"></span>

    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'A new list item'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">expected_html</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span>
        <span class="s">'home.html'</span><span class="p">,</span>
        <span class="p">{</span><span class="s">'new_item_text'</span><span class="p">:</span>  <span class="s">'A new list item'</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">expected_html</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>A reminder on a scratch piece of paper:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em>Code smell: POST test is too long?</em>
</p>
</li>
</ul></div>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</code></pre>
</div></div>
<div class="paragraph"><p>Let’s adjust our view:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="p">()</span>
    <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'item_text'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'new_item_text'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'item_text'</span><span class="p">,</span> <span class="s">''</span><span class="p">),</span>
    <span class="p">})</span>
</pre></div></div></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'new_item_text'</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">text</span>
    <span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s have a little look at our scratchpad. I’ve added a couple of the other
things that are on our mind:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em>Don’t save blank items for every request</em>
</p>
</li>
<li>
<p>
<em>Code smell: POST test is too long?</em>
</p>
</li>
<li>
<p>
<em>Display multiple items in the table</em>
</p>
</li>
<li>
<p>
<em>Support more than one list!</em>
</p>
</li>
</ul></div>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_home_page_only_saves_items_when_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gives us a <code>1 != 0</code> failure.</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">new_item_text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">]</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">new_item_text</span><span class="p">)</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_item_text</span> <span class="o">=</span> <span class="s">''</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'new_item_text'</span><span class="p">:</span> <span class="n">new_item_text</span><span class="p">,</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
    <span class="p">})</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 5 tests in 0.010s

OK</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_redirect_after_a_post">Redirect After a POST</h3>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_home_page_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s">'POST'</span>
        <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'A new list item'</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'A new list item'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">'location'</span><span class="p">],</span> <span class="s">'/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gives us the error <code>200 != 302</code>.  We can now tidy up our view
substantially:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch05l028)</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And the tests should now pass:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 5 tests in 0.010s

OK</code></pre>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced exercise: each test should test one thing</div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_home_page_can_save_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="err">?</span>


    <span class="k">def</span> <span class="nf">test_home_page_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="err">?</span>
</pre></div></div></div>
<div class="paragraph"><p>And we should now see six tests pass instead of five:</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>Ran 6 tests in 0.010s

OK</code></pre>
</div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_rendering_items_in_the_template">Rendering Items in the Template</h3>
<div class="paragraph"><p>Back to our to-do list:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Don’t save blank items for every request</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Code smell: POST test is too long?</span></em>
</p>
</li>
<li>
<p>
<em>Display multiple items in the table</em>
</p>
</li>
<li>
<p>
<em>Support more than one list!</em>
</p>
</li>
</ul></div>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HomePageTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_home_page_displays_all_list_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 1'</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 2'</span><span class="p">)</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'itemey 1'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'itemey 2'</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</pre></div></div></div>
<div class="paragraph"><p>That fails as expected:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'itemey 1' not found in '&lt;html&gt;\n    &lt;head&gt;\n [...]</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">"id_list_table"</span><span class="nt">&gt;</span>
    {% for item in items %}
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>1: {{ item.text }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
<span class="nt">&lt;/table&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Just changing the template doesn’t get our tests to pass; we need to actually
pass the items to it from our home page view:</p></div>
<!--?hard-pagebreak?-->
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'items'</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>
</pre></div></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise:</div>
<div class="paragraph"><p>If you didn’t find out about it in the last chapter, find out about the
Django Test Client.  How would you re-write our test(s) for the home page view
now?</p></div>
</div></div>
<div class="paragraph"><p>That does get the unit tests to pass … moment of truth, will the functional
test pass?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 functional_tests.py</strong>
[...]
AssertionError: 'To-Do' not found in 'OperationalError at /'</code></pre>
</div></div>
<div class="paragraph"><p>Oops, apparently not.  Let’s use another functional test debugging technique,
and it’s one of the most straightforward: manually visiting the site!  Open
up <em>http://localhost:8000</em> in your web browser, and you’ll see a Django debug
page saying "no such table: lists_item", as in <a href="#operationalerror">[operationalerror]</a>.</p></div>
<div class="imageblock" id="operationalerror">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/twdp_0502.png" alt="OperationalError at / no such table: lists_item">
</div>
<div class="title">Figure 9. Another helpful debug message</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_our_production_database_with_migrate">Creating Our Production Database with migrate</h3>
<div class="listingblock sourcecode currentcontents">
<div class="title">superlists/settings.py</div>
<div class="content"><div class="highlight"><pre><span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="c"># Database</span>
<span class="c"># https://docs.djangoproject.com/en/1.8/ref/settings/#databases</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.sqlite3'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'db.sqlite3'</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py migrate</strong>
Operations to perform:
  Synchronize unmigrated apps: messages, staticfiles
  Apply all migrations: contenttypes, lists, admin, auth, sessions
Synchronizing apps without migrations:
  Creating tables...
    Running deferred SQL...
  Installing custom SQL...
Running migrations:
  Rendering model states... DONE
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying lists.0001_initial... OK
  Applying lists.0002_item_text... OK
  Applying sessions.0001_initial... OK</code></pre>
</div></div>
<div class="paragraph"><p>Now we can refresh the page on <em>localhost</em>, see that our error is gone, and try
running the functional tests
again:<span data-note="If you get a different error at this point, try restarting your
dev server—it may have gotten confused by the changes to the database
happening under its feet." class="footnote">[<a id="_footnoteref_2" href="#_footnote_2" title="View footnote" class="footnote">2</a>]</span></p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers', '1: Use peacock feathers to make a fly']</code></pre>
</div></div>
<div class="paragraph"><p>So close!  We just need to get our list numbering right.  Another awesome
Django template tag, <code>forloop.counter</code>, will help here:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre>    {% for item in items %}
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ forloop.counter }}: {{ item.text }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
</pre></div></div></div>
<div class="paragraph"><p>If you try it again, you should now see the FT get to the end:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.fail('Finish the test!')
AssertionError: Finish the test!</code></pre>
</div></div>
<div class="paragraph"><p>Oh dear. It looks like previous runs of the test are leaving stuff lying around
in our database.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>1: Buy peacock feathers
2: Use peacock feathers to make a fly
3: Buy peacock feathers
4: Use peacock feathers to make a fly
5: Buy peacock feathers
6: Use peacock feathers to make a fly</code></pre>
</div></div>
<div class="paragraph"><p>Grrr.  We’re so close!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>rm db.sqlite3</strong>
$ <strong>python3 manage.py migrate --noinput</strong></code></pre>
</div></div>
<div class="paragraph"><p>That’s more or less working.  Commit for now.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git add lists</strong>
$ <strong>git commit -m "Redirect after POST, and show all items in template"</strong></code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">You might find it useful to add markers for the end of each chapter, like
<strong><code>git tag end-of-chapter-05</code></strong>.</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Where are we?</p></div>
<div class="ulist"><ul>
<li>
<p>
We’ve got a form set up to add new items to the list using POST.
</p>
</li>
<li>
<p>
We’ve set up a simple model in the database to save list items.
</p>
</li>
<li>
<p>
We’ve used at least three different FT debugging techniques.
</p>
</li>
</ul></div>
<div class="paragraph"><p>But we’ve got a couple of items on our own to-do list, namely getting the FT to
clean up after itself, and perhaps more critically, adding support for more
than one list.</p></div>
<div class="paragraph"><p>I mean, we <em>could</em> ship the site as it is, but people might find it
strange that the entire human population has to share a single to-do list.  I
suppose it might get people to stop and think about how connected we all are to
one another, how we all share a common destiny here on Spaceship Earth, and how
we must all work together to solve the global problems that we face.</p></div>
<div class="paragraph"><p>But in practical terms, the site wouldn’t be very useful.</p></div>
<div class="paragraph"><p>Ah well.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful TDD Concepts</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Regression
</dt>
<dd>
<p>
    When new code breaks some aspect of the application which used to work.
</p>
</dd>
<dt class="hdlist1">
Unexpected failure
</dt>
<dd>
<p>
    When a test fails in a way we weren’t expecting.  This either means that
    we’ve made a mistake in our tests, or that the tests have helped us find
    a regression, and we need to fix something in our code.
</p>
</dd>
<dt class="hdlist1">
Red/Green/Refactor
</dt>
<dd>
<p>
    Another way of describing the TDD process. Write a test and see it fail
    (Red), write some code to get it to pass (Green), then Refactor to improve
    the implementation.
</p>
</dd>
<dt class="hdlist1">
Triangulation
</dt>
<dd>
<p>
    Adding a test case with a new specific example for some existing code, to
    justify generalising the implementation (which may be a "cheat" until that
    point).
</p>
</dd>
<dt class="hdlist1">
Three strikes and refactor
</dt>
<dd>
<p>
    A rule of thumb for when to remove duplication from code. When two pieces
    of code look very similar, it often pays to wait until you see a third
    use case, so that you’re more sure about what part of the code really
    is the common, re-usable part to refactor out.
</p>
</dd>
<dt class="hdlist1">
The scratchpad to-do list
</dt>
<dd>
<p>
    A place to write down things that occur to us as we’re coding, so that
    we can finish up what we’re doing and come back to them later.
</p>
</dd>
</dl></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter-6">Getting to the Minimum Viable Site</h2>
<div class="sectionbody">
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
In which we use incremental, step-by-step refactoring to get to a better
app.  Testing Goat, not Refactoring Cat!
</p>
</li>
</ol></div>
<div class="sect2">
<h3 id="_ensuring_test_isolation_in_functional_tests">Ensuring Test Isolation in Functional Tests</h3>
<div class="paragraph"><p>We ended the last chapter with a classic testing problem:  how to ensure
<em>isolation</em> between tests.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>mkdir functional_tests</strong>
$ <strong>touch functional_tests/__init__.py</strong></code></pre>
</div></div>
<div class="paragraph"><p>Then move the FT file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git mv functional_tests.py functional_tests/tests.py</strong>
$ <strong>git status</strong> # shows the rename to functional_tests/tests.py and __init__.py</code></pre>
</div></div>
<div class="paragraph"><p>At this point your directory tree should look like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>.
├── db.sqlite3
├── functional_tests
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; └── tests.py
├── lists
│&nbsp;&nbsp; ├── admin.py
│&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; ├── migrations
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── 0001_initial.py
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── 0002_item_text.py
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── __init__.py
│&nbsp;&nbsp; │&nbsp;&nbsp; └── __pycache__
│&nbsp;&nbsp; ├── models.py
│&nbsp;&nbsp; ├── __pycache__
│&nbsp;&nbsp; ├── templates
│&nbsp;&nbsp; │&nbsp;&nbsp; └── home.html
│&nbsp;&nbsp; ├── tests.py
│&nbsp;&nbsp; └── views.py
├── manage.py
└── superlists
    ├── __init__.py
    ├── __pycache__
    ├── settings.py
    ├── urls.py
    └── wsgi.py</code></pre>
</div></div>
<div class="paragraph"><p><em>functional_tests.py</em> is gone, and has turned into <em>functional_tests/tests.py</em>.
Now, whenever we want to run our functional tests, instead of running <code>python3
functional_tests.py</code>, we will use <code>python3 manage.py test functional_tests</code>.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">discuss why keep FTs separate from other apps?</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Now let’s edit <em>functional_tests/tests.py</em> and change our <code>NewVisitorTest</code>
class to make it use <code>LiveServerTestCase</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py (ch06l001)</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">LiveServerTestCase</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>

<span class="k">class</span> <span class="nc">NewVisitorTest</span><span class="p">(</span><span class="n">LiveServerTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Next,
instead of hard-coding the visit to localhost port 8000, <code>LiveServerTestCase</code>
gives us an attribute called <code>live_server_url</code>:</p></div>
<div class="listingblock dofirst-ch06l003 sourcecode">
<div class="title">functional_tests/tests.py (ch06l002)</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_can_start_a_list_and_retrieve_it_later</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Edith has heard about a cool new online to-do app. She goes</span>
        <span class="c"># to check out its homepage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we are able to run our Functional tests using the Django test runner, by
telling it to run just the tests for our new <code>functional_tests</code> app:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test functional_tests</strong>
Creating test database for alias 'default'...
F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
(functional_tests.tests.NewVisitorTest)
 ---------------------------------------------------------------------
Traceback (most recent call last):
  File "/workspace/superlists/functional_tests/tests.py", line 61, in
test_can_start_a_list_and_retrieve_it_later
    self.fail('Finish the test!')
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 1 test in 6.378s

FAILED (failures=1)
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="paragraph"><p>Woot!</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Avanced Exercise: hand-rolled database cleanup</div>
<div class="paragraph"><p>Before LiveServerTestCase, you had to do this stuff yourself!  And it still
has some benefits.</p></div>
<div class="paragraph"><p>You can check out one of my old attempts, for inspiration, if you like:
<a href="https://github.com/hjwp/Test-Driven-Django-Tutorial/blob/old-ft-runner/mysite/functional_tests.py">old-ft-runner</a></p></div>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # functional_tests.py renamed + modified, new __init__.py
$ <strong>git add functional_tests</strong>
$ <strong>git diff --staged -M</strong>
$ <strong>git commit</strong>  # msg eg "make functional_tests an app, use LiveServerTestCase"</code></pre>
</div></div>
<div class="paragraph"><p>The <code>-M</code> flag on the <code>git diff</code> is a useful one. It means "detect moves", so it
will notice that <em>functional_tests.py</em> and <em>functional_tests/tests.py</em> are the
same file, and show you a more sensible diff (try it without the flag!).</p></div>
<div class="sect3">
<h4 id="_running_just_the_unit_tests">Running Just the Unit Tests</h4>
<div class="paragraph"><p>Now if we run <code>manage.py test</code>, Django will run both the functional and the
unit tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test</strong>
Creating test database for alias 'default'...
.......F
======================================================================
FAIL: test_can_start_a_list_and_retrieve_it_later
[...]
AssertionError: Finish the test!

 ---------------------------------------------------------------------
Ran 8 tests in 3.132s

FAILED (failures=1)
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="paragraph"><p>In order to run just the unit tests, we can specify that we want to
only run the tests for the <code>lists</code> app:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
Creating test database for alias 'default'...
.......
 ---------------------------------------------------------------------
Ran 7 tests in 0.009s

OK
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful Commands Updated</div>
<div class="dlist"><dl>
<dt class="hdlist1">
To run the functional tests
</dt>
<dd>
<p>
    <strong><code>python3 manage.py test functional_tests</code></strong>
</p>
</dd>
<dt class="hdlist1">
To run the unit tests
</dt>
<dd>
<p>
    <strong><code>python3 manage.py test lists</code></strong>
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>Currently the FT says this:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="c"># Edith wonders whether the site will remember her list. Then she sees</span>
    <span class="c"># that the site has generate a unique URL for her -- there is some</span>
    <span class="c"># explanatory text to that effect.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">'Finish the test!'</span><span class="p">)</span>

    <span class="c"># She visits that URL - her to-do list is still there.</span>

    <span class="c"># Satisfied, she goes back to sleep</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s think about this a bit more.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_small_design_when_necessary">Small Design When Necessary</h3>
<div class="ulist"><ul>
<li>
<p>
Big Design up-front
</p>
</li>
<li>
<p>
Minimum viable app
</p>
</li>
<li>
<p>
YAGNI
</p>
</li>
<li>
<p>
REST (ish)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Each list can have its own URL, like</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>    /lists/&lt;list identifier&gt;/</code></pre>
</div></div>
<div class="paragraph"><p>To create a brand new list, we’ll have a special URL that accepts POST
requests:</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>    /lists/new</code></pre>
</div></div>
<div class="paragraph"><p>To add a new item to an existing list, we’ll have a separate URL, to which
we can send POST requests:</p></div>
<div class="listingblock skipme">
<div class="content">
<pre><code>    /lists/&lt;list identifier&gt;/add_item</code></pre>
</div></div>
<div class="paragraph"><p>In summary, our scratchpad for this chapter looks something like this:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em>Adjust model so that items are associated with different lists</em>
</p>
</li>
<li>
<p>
<em>Add unique URLs for each list</em>
</p>
</li>
<li>
<p>
<em>Add a URL for creating a new list via POST</em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
</ul></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_implementing_the_new_design_using_tdd">Implementing the New Design Using TDD</h3>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Buy peacock feathers'</span><span class="p">)</span>

    <span class="c"># When she hits enter, she is taken to a new URL,</span>
    <span class="c"># and now the page lists "1: Buy peacock feathers" as an item in a</span>
    <span class="c"># to-do list table</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>
    <span class="n">edith_list_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">current_url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">edith_list_url</span><span class="p">,</span> <span class="s">'/lists/.+'</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">)</span>

    <span class="c"># There is still a text box inviting her to add another item. She</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Delete everything from the comments just before the <code>self.fail</code> (they say
"Edith wonders whether the site will remember her list …") and replace
them with a new ending to our FT:</p></div>
<div class="listingblock sourcecode">
<div class="title">functional_tests/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="c"># The page updates again, and now shows both items on her list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'2: Use peacock feathers to make a fly'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_for_row_in_list_table</span><span class="p">(</span><span class="s">'1: Buy peacock feathers'</span><span class="p">)</span>

    <span class="c"># Now a new user, Francis, comes along to the site.</span>

    <span class="c">## We use a new browser session to make sure that no information</span>
    <span class="c">## of Edith's is coming through from cookies etc #<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Firefox</span><span class="p">()</span>

    <span class="c"># Francis visits the home page.  There is no sign of Edith's</span>
    <span class="c"># list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">live_server_url</span><span class="p">)</span>
    <span class="n">page_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s">'body'</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">'Buy peacock feathers'</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">'make a fly'</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>

    <span class="c"># Francis starts a new list by entering a new item. He</span>
    <span class="c"># is less interesting than Edith...</span>
    <span class="n">inputbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'id_new_item'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'Buy milk'</span><span class="p">)</span>
    <span class="n">inputbox</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ENTER</span><span class="p">)</span>

    <span class="c"># Francis gets his own unique URL</span>
    <span class="n">francis_list_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">current_url</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">francis_list_url</span><span class="p">,</span> <span class="s">'/lists/.+'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">francis_list_url</span><span class="p">,</span> <span class="n">edith_list_url</span><span class="p">)</span>

    <span class="c"># Again, there is no trace of Edith's list</span>
    <span class="n">page_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_tag_name</span><span class="p">(</span><span class="s">'body'</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">'Buy peacock feathers'</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">'Buy milk'</span><span class="p">,</span> <span class="n">page_text</span><span class="p">)</span>

    <span class="c"># Satisfied, they both go back to sleep</span>
</pre></div></div></div>
<div class="paragraph"><p>*Ask about: double-hashes (<code>##</code>)</p></div>
<div class="paragraph"><p>Gives</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: Regex didn't match: '/lists/.+' not found in
'http://localhost:8081/'</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git commit -a</strong></code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_iterating_towards_the_new_design">Iterating Towards the New Design</h3>
<div class="paragraph"><p>The URL comes from the redirect after POST.  In <em>lists/tests.py</em>, find
<code>test_home_page_redirects_after_POST</code>, and change the expected redirect
location:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">'location'</span><span class="p">],</span> <span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Another way of thinking about it is as a problem-solving technique: our
    new URL design is currently not implemented, so it works for 0 items.
    Ultimately, we want to solve for <em>n</em> items, but solving for 1 item is a
    good step along the way.</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Running the unit tests gives us an expected fail:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
[...]
AssertionError: '/' != '/lists/the-only-list-in-the-world/'</code></pre>
</div></div>
<div class="paragraph"><p>We can go adjust our <code>home_page</code> view in <em>lists/views.py</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>

    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'items'</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>Of course that will now totally break the functional test.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.check_for_row_in_list_table('1: Buy peacock feathers')
[...]
selenium.common.exceptions.NoSuchElementException: Message: Unable to locate
element: {"method":"id","selector":"id_list_table"}</code></pre>
</div></div>
<div class="paragraph"><p>So, let’s build a special URL for our one and only list.</p></div>
</div>
<div class="sect2">
<h3 id="_testing_views_templates_and_urls_together_with_the_django_test_client">Testing Views, Templates, and URLs Together with the Django Test Client</h3>
<div class="sect3">
<h4 id="_a_new_test_class">A New Test Class</h4>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l009)</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ListViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_displays_all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 1'</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 2'</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'itemey 1'</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'itemey 2'</span><span class="p">)</span> <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/2.png" alt="2"></span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s try running the test now:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_a_new_url">A New URL</h4>
<div class="paragraph"><p>Our singleton list URL doesn’t exist yet.  We fix that in <em>superlists/urls.py</em>.</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/tip.png" alt="Tip">
</td>
<td class="content">Watch out for trailing slashes in URLs, both here in the tests and in
<em>urls.py</em>—They’re a common source of bugs.</td>
</tr></tbody></table>
</div>
<div class="listingblock sourcecode small-code">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'lists.views.home_page'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/the-only-list-in-the-world/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
    <span class="c"># url(r'^admin/', include(admin.site.urls)),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Running the tests again, we get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AttributeError: 'module' object has no attribute 'view_list'
[...]
FAILED (errors=4)</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_a_new_view_function">A New View Function</h4>
<div class="paragraph"><p>Nicely self-explanatory.  Let’s create a dummy view function in
<em>lists/views.py</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ValueError: The view lists.views.view_list didn't return an HttpResponse
object. It returned None instead.</code></pre>
</div></div>
<div class="paragraph"><p>Let’s copy the two last lines from the <code>home_page</code> view and see if they’ll do
the trick:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'items'</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>Rerun the tests and they should pass:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 8 tests in 0.016s
OK</code></pre>
</div></div>
<div class="paragraph"><p>And the FTs should get a little further on:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</code></pre>
</div></div>
<div class="sect4">
<h5 id="_green_refactor">Green? Refactor</h5>
<div class="paragraph"><p>Time for a little tidying up.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>grep -E "class|def" lists/tests.py</strong>
class HomePageTest(TestCase):
    def test_root_url_resolves_to_home_page_view(self):
    def test_home_page_returns_correct_html(self):
    def test_home_page_displays_all_list_items(self):
    def test_home_page_can_save_a_POST_request(self):
    def test_home_page_redirects_after_POST(self):
    def test_home_page_only_saves_items_when_necessary(self):
class ListViewTest(TestCase):
    def test_displays_all_items(self):
class ItemModelTest(TestCase):
    def test_saving_and_retrieving_items(self):</code></pre>
</div></div>
<div class="paragraph"><p>We can definitely delete the <code>test_home_page_displays_all_list_items</code> method,
it’s no longer needed.  If you run <strong><code>manage.py test lists</code></strong> now, it should say
it ran 7 tests instead of 8:</p></div>
<div class="listingblock dofirst-ch06l010">
<div class="content">
<pre><code>Ran 7 tests in 0.016s
OK</code></pre>
</div></div>
<div class="paragraph"><p>Next, we don’t actually need the home page to display all list items any more;
it should just show a single input box inviting you to start a new list.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_a_separate_template_for_viewing_lists">A Separate Template for Viewing Lists</h4>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ListViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_uses_list_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_displays_all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Let’s see what it says:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : Template 'list.html' was not a template
used to render the response. Actual template(s) used: home.html</code></pre>
</div></div>
<div class="paragraph"><p>Great!  Let’s change the view:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'items'</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>But, obviously, that template doesn’t exist yet. If we run the unit tests, we
get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>django.template.base.TemplateDoesNotExist: list.html</code></pre>
</div></div>
<div class="paragraph"><p>Let’s create a new file at <em>lists/templates/list.html</em>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>touch lists/templates/list.html</strong></code></pre>
</div></div>
<div class="paragraph"><p>A blank template, which gives us this error—good to know the tests are
there to make sure we fill it in:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : Couldn't find 'itemey 1' in response</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>cp lists/templates/home.html lists/templates/list.html</strong></code></pre>
</div></div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/templates/home.html</div>
<div class="content"><div class="highlight"><pre><span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Start a new To-Do list<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"item_text"</span> <span class="na">id=</span><span class="s">"id_new_item"</span> <span class="na">placeholder=</span><span class="s">"Enter a to-do item"</span> <span class="nt">/&gt;</span>
        {% csrf_token %}
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div></div></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/list.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;h1&gt;</span>Your To-Do list<span class="nt">&lt;/h1&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>We re-run the unit tests to check that hasn’t broken anything… Good…</p></div>
<div class="paragraph"><p>There’s actually no need to pass all the items to the <em>home.html</em> template in
our <code>home_page</code> view, so we can simplify that:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Rerun the unit tests; they still pass. Let’s run the functional tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Buy
peacock feathers']</code></pre>
</div></div>
<div class="paragraph"><p>The <code>action=</code> attribute…</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/list.html (ch06l019)</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/"</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>And try running the FT again:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertNotEqual(francis_list_url, edith_list_url)
AssertionError: 'http://localhost:8081/lists/the-only-list-in-the-world/' ==
'http://localhost:8081/lists/the-only-list-in-the-world/'</code></pre>
</div></div>
<div class="paragraph"><p>Hooray! We’re back to where we were earlier, which means our refactoring is
complete—we now have a unique URL for our one list.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # should show 4 changed files and 1 new file, list.html
$ <strong>git add lists/templates/list.html</strong>
$ <strong>git diff</strong> # should show we've simplified home.html,
           # moved one test to a new class in lists/tests.py added a new view
           # in views.py, and simplified home_page and made one addition to
           # urls.py
$ <strong>git commit -a</strong> # add a message summarising the above, maybe something like
                # "new URL, view and template to display lists"</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_another_url_and_view_for_adding_list_items">Another URL and View for Adding List Items</h3>
<div class="paragraph"><p>Where are we with our own to-do list?</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em>Adjust model so that items are associated with different lists</em>
</p>
</li>
<li>
<p>
<em>Add unique URLs for each list</em>
</p>
</li>
<li>
<p>
<em>Add a URL for creating a new list via POST</em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Let’s have a new URL for adding new list items.  If nothing else, it’ll
simplify the home page view.</p></div>
<div class="sect3">
<h4 id="_a_test_class_for_new_list_creation">A Test Class for New List Creation</h4>
<div class="paragraph"><p>Open up <em>lists/tests.py</em>, and <em>move</em> the
<code>test_home_page_can_save_a_POST_request</code> and
<code>test_home_page_redirects_after_POST</code> methods into a new class, then change
their names:</p></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">if you didn’t do the advanced exercise in the last section, you’ll only
have one method here. That’s fine.</td>
</tr></tbody></table>
</div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l021-1)</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewListTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_saving_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">HttpRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s">'POST'</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Now let’s use the Django test client:</p></div>
<div class="listingblock sourcecode small-code">
<div class="title">lists/tests.py (ch06l021-2)</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewListTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_saving_a_POST_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/new'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new list item'</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'A new list item'</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/new'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new list item'</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">'location'</span><span class="p">],</span> <span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>This is another place to pay attention to trailing slashes, incidentally. It’s
<code>/new</code>, with no trailing slash.  The convention I’m using is that URLs without
a trailing slash are "action" URLs which modify the database.</p></div>
<div class="paragraph"><p>Try running that:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
    self.assertEqual(response.status_code, 302)
AssertionError: 404 != 302</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_a_url_and_view_for_new_list_creation">A URL and View for New List Creation</h4>
<div class="paragraph"><p>Let’s build our new URL now:</p></div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'lists.views.home_page'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/new$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">new_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'new_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/the-only-list-in-the-world/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
    <span class="c"># url(r'^admin/', include(admin.site.urls)),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Next we get a <code>no attribute 'new_list'</code>, so let’s fix that, in <em>lists/views.py</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gives:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1
[...]
AssertionError: 'http://testserver/lists/the-only-list-in-the-world/' !=
'/lists/the-only-list-in-the-world/'</code></pre>
</div></div>
<div class="paragraph"><p>Let’s start with the first failure, because it’s reasonably straightforward. We
borrow another line from <code>home_page</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And that takes us down to just the second, unexpected failure:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(response['location'],
'/lists/the-only-list-in-the-world/')
AssertionError: 'http://testserver/lists/the-only-list-in-the-world/' !=
'/lists/the-only-list-in-the-world/'</code></pre>
</div></div>
<div class="paragraph"><p>Let’s use another of Django’s test helper functions instead of our two-step
check for the redirect:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/new'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new list item'</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That now passes:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 8 tests in 0.030s

OK</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_removing_now_redundant_code_and_tests">Removing Now-Redundant Code and Tests</h4>
<div class="paragraph"><p>We’re looking good. Since our new views are now doing most of the work that
<code>home_page</code> used to do, we should be able to massively simplify it. Can we
remove the whole <code>if request.method == 'POST'</code> section, for example?</p></div>
<!--?hard-pagebreak?-->
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'home.html'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Yep!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>OK</code></pre>
</div></div>
<div class="paragraph"><p>And while we’re at it, we can remove the now-redundant
<code>test_home_page_only_saves_</code> <code>items_when_necessary</code> test too!</p></div>
<div class="paragraph"><p>Doesn’t that feel good?  The view functions are looking much simpler. We rerun
the tests to make sure…</p></div>
<div class="listingblock dofirst-ch06l026">
<div class="content">
<pre><code>Ran 7 tests in 0.016s
OK</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_pointing_our_forms_at_the_new_url">Pointing Our Forms at the New URL</h4>
<div class="paragraph"><p>Finally, let’s wire up our two forms to use this new URL.  In <em>both</em>
<em>home.html</em> and <em>lists.html</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/home.html, lists/templates/list.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/lists/new"</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise</div>
<div class="paragraph"><p>We’re violating DRY with all these hard-coded URLs.  Investigate the Django
<code>{% url %}</code> tag, and the <code>reverse</code> and <code>redirect</code> functions, and use them as
appropriate</p></div>
</div></div>
<div class="paragraph"><p>And we re-run our FTs to make sure everything still works…</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'http://localhost:8081/lists/the-only-list-in-the-world/' ==
'http://localhost:8081/lists/the-only-list-in-the-world/'</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # 5 changed files
$ <strong>git diff</strong> # URLs for forms x2, moved code in views + tests, new URL
$ <strong>git commit -a</strong></code></pre>
</div></div>
<div class="paragraph"><p>And we can cross out an item on the to-do list:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em>Adjust model so that items are associated with different lists</em>
</p>
</li>
<li>
<p>
<em>Add unique URLs for each list</em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
</ul></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_adjusting_our_models">Adjusting Our Models</h3>
<div class="paragraph"><p>Just for fun, a diff output instead of a plain code listing:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="gu">@@ -3,7 +3,7 @@ from django.http import HttpRequest</span>
 from django.template.loader import render_to_string
 from django.test import TestCase

<span class="gd">-from lists.models import Item</span>
<span class="gi">+from lists.models import Item, List</span>
 from lists.views import home_page

 class HomePageTest(TestCase):
<span class="gu">@@ -60,22 +60,32 @@ class ListViewTest(TestCase):</span>



<span class="gd">-class ItemModelTest(TestCase):</span>
<span class="gi">+class ListAndItemModelsTest(TestCase):</span>

     def test_saving_and_retrieving_items(self):
<span class="gi">+        list_ = List()</span>
<span class="gi">+        list_.save()</span>
<span class="gi">+</span>
         first_item = Item()
         first_item.text = 'The first (ever) list item'
<span class="gi">+        first_item.list = list_</span>
         first_item.save()

         second_item = Item()
         second_item.text = 'Item the second'
<span class="gi">+        second_item.list = list_</span>
         second_item.save()

<span class="gi">+        saved_list = List.objects.first()</span>
<span class="gi">+        self.assertEqual(saved_list, list_)</span>
<span class="gi">+</span>
         saved_items = Item.objects.all()
         self.assertEqual(saved_items.count(), 2)

         first_saved_item = saved_items[0]
         second_saved_item = saved_items[1]
         self.assertEqual(first_saved_item.text, 'The first (ever) list item')
<span class="gi">+        self.assertEqual(first_saved_item.list, list_)</span>
         self.assertEqual(second_saved_item.text, 'Item the second')
<span class="gi">+        self.assertEqual(second_saved_item.list, list_)</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">I’m using the variable name <code>list_</code> to avoid "shadowing" the Python
built-in <code>list</code> function.  It’s ugly, but all the other options I tried were
equally ugly or worse (<code>my_list</code>, <code>the_list</code>, <code>list1</code>, <code>listey</code>…).</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Time for another unit-test/code cycle.</p></div>
<div class="paragraph"><p>For the first couple of iterations, rather than explicitly showing you what
code to enter in between every test run, I’m only going to show you the
expected error messages from running the tests.  I’ll let you figure out what
each minimal code change should be on your own:</p></div>
<div class="paragraph"><p>Your first error should be:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ImportError: cannot import name 'List'</code></pre>
</div></div>
<div class="paragraph"><p>Fix that, then you should see:</p></div>
<div class="listingblock dofirst-ch06l029-1">
<div class="content">
<pre><code>AttributeError: 'List' object has no attribute 'save'</code></pre>
</div></div>
<div class="paragraph"><p>Next you should see:</p></div>
<div class="listingblock dofirst-ch06l029-2">
<div class="content">
<pre><code>django.db.utils.OperationalError: no such table: lists_list</code></pre>
</div></div>
<div class="paragraph"><p>So we run a <code>makemigrations</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0003_list.py:
    - Create model List</code></pre>
</div></div>
<div class="paragraph"><p>And then you should see:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(first_saved_item.list, list_)
AttributeError: 'Item' object has no attribute 'list'</code></pre>
</div></div>
<div class="sect3">
<h4 id="_a_foreign_key_relationship">A Foreign Key Relationship</h4>
<div class="paragraph"><p>How do we give our <code>Item</code> a list attribute?  Let’s just try naively making it
like the <code>text</code> attribute:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>As usual, the tests tell us we need a migration:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
[...]
django.db.utils.OperationalError: no such column: lists_item.list

$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0004_item_list.py:
    - Add field list to item</code></pre>
</div></div>
<div class="paragraph"><p>Let’s see what that gives us:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'List object' != &lt;List: List object&gt;</code></pre>
</div></div>
<div class="paragraph"><p>We’re not quite there. Look closely at each side of the <code>!=</code>.  Django has only
saved the string representation of the <code>List</code> object. To save the relationship
to the object itself, we tell Django about the relationship between the two
classes using a <code>ForeignKey</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/models.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">List</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That’ll need a migration too.  Since the last one was a red herring, let’s
delete it and replace it with a new one:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>rm lists/migrations/0004_item_list.py</strong>
$ <strong>python3 manage.py makemigrations</strong>
Migrations for 'lists':
  0004_item_list.py:
    - Add field list to item</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">ask about why deleting migrations is dangerous</td>
</tr></tbody></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Advanced Exercise</div>
<div class="paragraph"><p>If you switch to a <code>CharField</code> instead of a <code>TextField</code>, you’ll see we need
a <code>max_length</code> attribute.  How would you test that?  It’s not obvious,
so ask for a hint if you need one…</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_adjusting_the_rest_of_the_world_to_our_new_models">Adjusting the Rest of the World to Our New Models</h4>
<div class="paragraph"><p>Back in our tests, now what happens?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test lists</strong>
[...]
ERROR: test_displays_all_items (lists.tests.ListViewTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id
[...]
ERROR: test_saving_a_POST_request (lists.tests.NewListTest)
django.db.utils.IntegrityError: NOT NULL constraint failed: lists_item.list_id

Ran 7 tests in 0.021s

FAILED (errors=3)</code></pre>
</div></div>
<div class="paragraph"><p>Oh gawd!  Still, this is exactly why we have tests.</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l031)</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ListViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_displays_all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 1'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 2'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>That gets us down to two failing tests, both on tests that try to POST to our
<code>new_list</code> view. Decoding the tracebacks using our usual technique, working back
from error, to line of test code, to the line of our own code that caused the
failure, we identify:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>File "/workspace/superlists/lists/views.py", line 14, in new_list
Item.objects.create(text=request.POST['item_text'])</code></pre>
</div></div>
<div class="paragraph"><p>It’s when we try and create an item without a parent list. So we make a similar
change in the view:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">lists.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">List</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">],</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And that gets our tests passing again:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>OK</code></pre>
</div></div>
<div class="admonitionblock">
<table><tbody><tr>
<td class="icon">
<img src="Test-Driven%20Development%20with%20Python_files/note.png" alt="Note">
</td>
<td class="content">Are you cringing internally at this point?  Ask!</td>
</tr></tbody></table>
</div>
<div class="paragraph"><p>Anyway, just to reassure ourselves that things have worked, we can re-run the
FT.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong> # 3 changed files, plus 2 migrations
$ <strong>git add lists</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></code></pre>
</div></div>
<div class="paragraph"><p>And we can cross out another item on the to-do list:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em>
</p>
</li>
<li>
<p>
<em>Add unique URLs for each list</em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
</ul></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_each_list_should_have_its_own_url">Each List Should Have Its Own URL</h3>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l033-1)</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ListViewTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_uses_list_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">list_</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_displays_only_items_for_that_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 1'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">correct_list</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'itemey 2'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">correct_list</span><span class="p">)</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'other list item 1'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">other_list</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">'other list item 2'</span><span class="p">,</span> <span class="nb">list</span><span class="o">=</span><span class="n">other_list</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">correct_list</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'itemey 1'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'itemey 2'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'other list item 1'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'other list item 2'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Running the unit tests gives an expected 404, and another related error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
AssertionError: 404 != 200 : Couldn't retrieve content: Response code was 404
(expected 200)
[...]
FAIL: test_uses_list_template (lists.tests.ListViewTest)
AssertionError: No templates used to render the response</code></pre>
</div></div>
<div class="sect3">
<h4 id="_capturing_parameters_from_urls">Capturing Parameters from URLs</h4>
<div class="paragraph"><p>It’s time to learn how we can pass parameters from URLs to views:</p></div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="s">'lists.views.home_page'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/new$'</span><span class="p">,</span> <span class="s">'lists.views.new_list'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'new_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/(.+)/$'</span><span class="p">,</span> <span class="s">'lists.views.view_list'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
    <span class="c"># url(r'^admin/', include(admin.site.urls)),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>But our view doesn’t expect an argument yet! Sure enough, this causes problems:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ERROR: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
ERROR: test_uses_list_template (lists.tests.ListViewTest)
ERROR: test_redirects_after_POST (lists.tests.NewListTest)
[...]
TypeError: view_list() takes 1 positional argument but 2 were given</code></pre>
</div></div>
<div class="paragraph"><p>We can fix that easily with a dummy parameter in <em>views.py</em>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we’re down to our expected failure:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>FAIL: test_displays_only_items_for_that_list (lists.tests.ListViewTest)
AssertionError: 1 != 0 : Response should not contain 'other list item 1'</code></pre>
</div></div>
<div class="paragraph"><p>Let’s make our view discriminate over which items it sends to the
template:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'items'</span><span class="p">:</span> <span class="n">items</span><span class="p">})</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_adjusting_new_list_to_the_new_world">Adjusting new_list to the New World</h4>
<div class="paragraph"><p>Now we get errors in another test:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ERROR: test_redirects_after_POST (lists.tests.NewListTest)
ValueError: invalid literal for int() with base 10:
'the-only-list-in-the-world'</code></pre>
</div></div>
<div class="paragraph"><p>Let’s take a look at this test then, since it’s whining:</p></div>
<div class="listingblock sourcecode currentcontents">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewListTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/new'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new list item'</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'/lists/the-only-list-in-the-world/'</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>It looks like it hasn’t been adjusted to the new world of Lists and Items.
The test should be saying that this view redirects to the URL of the new list
it just created:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l036-1)</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_redirects_after_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/new'</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new list item'</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_list</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
</pre></div></div></div>
<div class="paragraph"><p>That still gives us the <em>invalid literal</em> error. We take a look at the view
itself, and change it so it redirects to a valid place:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py (ch06l036-2)</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">new_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">],</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">list_</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
</pre></div></div></div>
<div class="paragraph"><p>That gets us back to passing unit tests.  What about the functional
tests?  We must be almost there?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '2: Use peacock feathers to make a fly' not found in ['1: Use
peacock feathers to make a fly']</code></pre>
</div></div>
<div class="paragraph"><p>And it correlates nicely with the last item on our to-do list:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add unique URLs for each list</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>This is exactly what we have functional tests for!</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_one_more_view_to_handle_adding_items_to_an_existing_list">One More View to Handle Adding Items to an Existing List</h3>
<div class="paragraph"><p>We need a URL and view to handle adding a new item to an existing list (
<em>/lists/&lt;list_id&gt;/add_item</em>).  We’re getting pretty good at these now, so let’s
knock one together quickly:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py</div>
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewItemTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_can_save_a_POST_request_to_an_existing_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/</span><span class="si">%d</span><span class="s">/add_item'</span> <span class="o">%</span> <span class="p">(</span><span class="n">correct_list</span><span class="o">.</span><span class="n">id</span><span class="p">,),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new item for an existing list'</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'A new item for an existing list'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="n">correct_list</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_redirects_to_list_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">'/lists/</span><span class="si">%d</span><span class="s">/add_item'</span> <span class="o">%</span> <span class="p">(</span><span class="n">correct_list</span><span class="o">.</span><span class="n">id</span><span class="p">,),</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'item_text'</span><span class="p">:</span> <span class="s">'A new item for an existing list'</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">correct_list</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
</pre></div></div></div>
<div class="paragraph"><p>We get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 0 != 1
[...]
AssertionError: 301 != 302 : Response didn't redirect as expected: Response
code was 301 (expected 302)</code></pre>
</div></div>
<div class="sect3">
<h4 id="_beware_of_greedy_regular_expressions">Beware of Greedy Regular Expressions!</h4>
<div class="paragraph"><p>This was a bit of a puzzler, but it’s because we’ve used a very "greedy"
regular expression in our URL:</p></div>
<div class="listingblock skipme">
<div class="content"><div class="highlight"><pre>    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/(.+)/$'</span><span class="p">,</span> <span class="s">'lists.views.view_list'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
</pre></div></div></div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre>    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/(\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
</pre></div></div></div>
<div class="paragraph"><p>That gives:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 0 != 1
[...]
AssertionError: 404 != 302 : Response didn't redirect as expected: Response
code was 404 (expected 302)</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_the_last_new_url">The Last New URL</h4>
<div class="paragraph"><p>Now we’ve got our expected 404, let’s add a new URL for adding new items to
existing lists:</p></div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/new$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">new_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'new_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/(\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/(\d+)/add_item$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add_item</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'add_item'</span><span class="p">),</span>
    <span class="c"># url(r'^admin/', include(admin.site.urls)),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="paragraph"><p>Three very similar-looking URLs there.  Let’s make a note on our
to-do list; they look like good candidates for a refactoring.</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add unique URLs for each list</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em>
</p>
</li>
<li>
<p>
<em>Add URLs for adding a new item to an existing list via POST</em>
</p>
</li>
<li>
<p>
<em>Refactor away some duplication in urls.py</em>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Back to the tests, we get the usual missing module objects:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AttributeError: 'module' object has no attribute 'add_item'</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_the_last_new_view">The Last New View</h4>
<div class="paragraph"><p>Let’s try:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="paragraph"><p>Aha:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>TypeError: add_item() takes 1 positional argument but 2 were given</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div></div></div>
<div class="paragraph"><p>And then:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ValueError: The view lists.views.add_item didn't return an HttpResponse object.
It returned None instead.</code></pre>
</div></div>
<!--?hard-pagebreak?-->
<div class="paragraph"><p>We can copy the <code>redirect</code> from <code>new_list</code> and the <code>List.objects.get</code> from
<code>view_list</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">list_</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
</pre></div></div></div>
<div class="paragraph"><p>That takes us to:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(Item.objects.count(), 1)
AssertionError: 0 != 1</code></pre>
</div></div>
<div class="paragraph"><p>Finally we make it save our new list item:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'item_text'</span><span class="p">],</span> <span class="nb">list</span><span class="o">=</span><span class="n">list_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">list_</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
</pre></div></div></div>
<div class="paragraph"><p>And we’re back to passing tests.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 9 tests in 0.050s

OK</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_but_how_to_use_that_url_in_the_form">But How to Use That URL in the Form?</h4>
<div class="paragraph"><p>Now we just need to use this URL in our <em>list.html</em> template.  Open it up and
adjust the form tag…</p></div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"but what should we put here?"</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="listingblock sourcecode skipme">
<div class="title">lists/templates/list.html</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/lists/{{ list.id }}/add_item"</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>For that to work, the view will have to pass the list to the template.
Let’s create a new unit test in <code>ListViewTest</code>:</p></div>
<div class="listingblock sourcecode">
<div class="title">lists/tests.py (ch06l041)</div>
<div class="content"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_passes_correct_list_to_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">correct_list</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/lists/</span><span class="si">%d</span><span class="s">/'</span> <span class="o">%</span> <span class="p">(</span><span class="n">correct_list</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s">'list'</span><span class="p">],</span> <span class="n">correct_list</span><span class="p">)</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content">
<pre><code>KeyError: 'list'</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/views.py</div>
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">list_id</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">list_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'list.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'list'</span><span class="p">:</span> <span class="n">list_</span><span class="p">})</span>
</pre></div></div></div>
<div class="paragraph"><p>That, of course, will break because the template is expecting <code>items</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: False is not true : Couldn't find 'itemey 1' in response</code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">lists/templates/list.html (ch06l043)</div>
<div class="content"><div class="highlight"><pre>    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/lists/{{ list.id }}/add_item"</span><span class="nt">&gt;</span>

    [...]

        {% for item in list.item_set.all %}
            <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ forloop.counter }}: {{ item.text }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
        {% endfor %}
</pre></div></div></div>
<div class="paragraph"><p>So that gets the unit tests to pass:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Ran 10 tests in 0.060s

OK</code></pre>
</div></div>
<div class="paragraph"><p>How about the FT?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>python3 manage.py test functional_tests</strong>
Creating test database for alias 'default'...
.
 ---------------------------------------------------------------------
Ran 1 test in 5.824s

OK
Destroying test database for alias 'default'...</code></pre>
</div></div>
<div class="paragraph"><p>Yes!  And a quick check on our to-do list:</p></div>
<div class="sidebarblock scratchpad">
<div class="content">
<div class="ulist"><ul>
<li>
<p>
<em><span class="strikethrough line-through">Get FTs to clean up after themselves</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Adjust model so that items are associated with different lists</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add unique URLs for each list</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add a URL for creating a new list via POST</span></em>
</p>
</li>
<li>
<p>
<em><span class="strikethrough line-through">Add URLs for adding a new item to an existing list via POST</span></em>
</p>
</li>
<li>
<p>
<em>Refactor away some duplication in urls.py</em>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Irritatingly, the Testing Goat is a stickler for tying up loose ends too, so
we’ve got to do this one final thing.</p></div>
<div class="paragraph"><p>Before we start, we’ll do a commit—always make sure you’ve got a commit
of a working state before embarking on a refactor:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git diff</strong>
$ <strong>git commit -am "new URL + view for adding to existing lists. FT passes :-)"</strong></code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_a_final_refactor_using_url_includes">A Final Refactor Using URL includes</h3>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>cp superlists/urls.py lists/</strong></code></pre>
</div></div>
<div class="listingblock sourcecode">
<div class="title">superlists/urls.py</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">views</span> <span class="k">as</span> <span class="n">list_views</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>
<span class="kn">from</span> <span class="nn">lists</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">list_urls</span>  <span class="c">#<img src="Test-Driven%20Development%20with%20Python_files/1.png" alt="1"></span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">list_views</span><span class="o">.</span><span class="n">home_page</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^lists/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">list_urls</span><span class="p">)),</span>
    <span class="c"># url(r'^admin/', include(admin.site.urls)),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="ulist"><ul>
<li>
<p>
Ask about: <code>import x as y</code>
</p>
</li>
</ul></div>
<div class="listingblock sourcecode">
<div class="title">lists/urls.py (ch06l045)</div>
<div class="content"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^new$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">new_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'new_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^(\d+)/$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">view_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'view_list'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^(\d+)/add_item$'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">add_item</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'add_item'</span><span class="p">),</span>
<span class="p">]</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content">
<pre><code>$ <strong>git status</strong>
$ <strong>git add lists/urls.py</strong>
$ <strong>git add superlists/urls.py</strong>
$ <strong>git diff --staged</strong>
$ <strong>git commit</strong></code></pre>
</div></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Useful TDD Concepts and Rules Of Thumb</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Test Isolation and Global State
</dt>
<dd>
<p>
    Different tests shouldn’t affect one another.  This means we need to
    reset any permanent state at the end of each test. Django’s test runner
    helps us do this by creating a test database, which it wipes clean in
    between each test.  (See also <a href="#isolation-chapter">[isolation-chapter]</a>.)
    
    
</p>
</dd>
<dt class="hdlist1">
Working State to Working State (aka The Testing Goat vs. Refactoring Cat)
</dt>
<dd>
<p>
    Our natural urge is often to dive in and fix everything at once … but if
    we’re not careful, we’ll end up like Refactoring Cat, in a situation with
    loads of changes to our code and nothing working.  The Testing Goat
    encourages us to take one step at a time, and go from working state to
    working state.
    
    
    
</p>
</dd>
<dt class="hdlist1">
YAGNI
</dt>
<dd>
<p>
    You ain’t gonna need it!  Avoid the temptation to write code that you
    think <em>might</em> be useful, just because it suggests itself at the time.
    Chances are, you won’t use it, or you won’t have anticipated your
    future requirements correctly.  See <a href="#outside-in-chapter">[outside-in-chapter]</a> for one
    methodology that helps us avoid this trap.
</p>
</dd>
</dl></div>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_follow_up">Follow up!</h2>
<div class="sectionbody">
<div class="paragraph"><p>Find the full book online at:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.obeythetestinggoat.com/">www.obeythetestinggoat.com</a>
</p>
</li>
</ul></div>
<div class="imageblock" id="testing-goat-toon">
<div class="content">
<img src="Test-Driven%20Development%20with%20Python_files/kid_goat.png" alt="The Testing Goat says bye!">
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr><div class="footnote" id="_footnote_1"><a href="#_footnoteref_1" title="Return to text">1</a>. I updated the book to Django 1.8 in Spring 2015, and as it’s an
LTS, this will probably be the last upgrade for a while.  Make sure you install
this version, even if the Django project have released a newer one since.  You
can always jump to the bleeding edge when you go back to your own projects!</div><div class="footnote" id="_footnote_2"><a href="#_footnoteref_2" title="Return to text">2</a>. If you get a different error at this point, try restarting your
dev server—it may have gotten confused by the changes to the database
happening under its feet.</div></div>
<div id="footer">
<div id="footer-text">
Last updated 2015-06-04 08:28:53 BST
</div>
</div>


</body></html>